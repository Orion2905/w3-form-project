{% extends 'layout_full.html' %}
{% set show_sidebar_toggle = False %}
{% block main_content %}
<style>
.required-field::after {
  content: " *";
  color: red;
  font-weight: bold;
}

.missing-field {
  border: 2px solid #dc3545 !important;
  background-color: #f8d7da !important;
}

.missing-fields-summary {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 0.375rem;
  padding: 1rem;
  margin-bottom: 1rem;
  display: none;
}

.missing-fields-summary.show {
  display: block;
}

.validation-error {
  color: #dc3545;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

/* Stili per le sezioni del form */
.form-section {
  border: 1px solid rgba(0, 0, 0, 0.125);
  border-radius: 0.5rem;
  margin-bottom: 1.5rem;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.form-section:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
  transform: translateY(-1px);
}

.section-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
  border-radius: 0.5rem 0.5rem 0 0;
  padding: 1rem 1.25rem;
}

.section-title {
  color: #495057;
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  margin: 0;
}

.section-title i {
  color: #6c757d;
  font-size: 1.2rem;
  margin-right: 0.5rem;
}

.section-body {
  padding: 1.25rem;
}

/* Icone specifiche per tipo di sezione */
.section-title .bi-geo-alt {
  color: #0d6efd !important;
}

.section-title .bi-person {
  color: #6f42c1 !important;
}

.section-title .bi-heart {
  color: #e91e63 !important;
}

.section-title .bi-rulers {
  color: #ff9800 !important;
}

.section-title .bi-camera {
  color: #00bcd4 !important;
}

.section-title .bi-person-badge {
  color: #6f42c1 !important;
}

.section-title .bi-file-earmark-text {
  color: #fd7e14 !important;
}

.section-title .bi-credit-card {
  color: #198754 !important;
}

.section-title .bi-car-front {
  color: #dc3545 !important;
}

.section-title .bi-file-arrow-up {
  color: #20c997 !important;
}

.section-title .bi-briefcase {
  color: #795548 !important;
}

.section-title .bi-calendar-check {
  color: #4caf50 !important;
}

.section-title .bi-translate {
  color: #9c27b0 !important;
}

.section-title .bi-shield-check {
  color: #607d8b !important;
}

/* Tema scuro per le sezioni */
body[data-theme="dark"] .form-section {
  background-color: #343a40;
  border-color: #495057;
}

body[data-theme="dark"] .section-header {
  background: linear-gradient(135deg, #495057 0%, #343a40 100%);
  border-bottom-color: #495057;
}

body[data-theme="dark"] .section-title {
  color: #f8f9fa;
}

body[data-theme="dark"] .section-title i {
  color: #adb5bd;
}

/* Tema scuro per icone - mantieni i colori originali per distinguere le sezioni */
body[data-theme="dark"] .section-title .bi-geo-alt {
  color: #6ea8fe !important;
}

body[data-theme="dark"] .section-title .bi-person {
  color: #a370f7 !important;
}

body[data-theme="dark"] .section-title .bi-heart {
  color: #f48fb1 !important;
}

body[data-theme="dark"] .section-title .bi-rulers {
  color: #ffb74d !important;
}

body[data-theme="dark"] .section-title .bi-camera {
  color: #4dd0e1 !important;
}

body[data-theme="dark"] .section-title .bi-person-badge {
  color: #a370f7 !important;
}

body[data-theme="dark"] .section-title .bi-file-earmark-text {
  color: #fd9843 !important;
}

body[data-theme="dark"] .section-title .bi-credit-card {
  color: #75b798 !important;
}

body[data-theme="dark"] .section-title .bi-car-front {
  color: #f1948a !important;
}

body[data-theme="dark"] .section-title .bi-file-arrow-up {
  color: #73e2a7 !important;
}

body[data-theme="dark"] .section-title .bi-briefcase {
  color: #a1887f !important;
}

body[data-theme="dark"] .section-title .bi-calendar-check {
  color: #81c784 !important;
}

body[data-theme="dark"] .section-title .bi-translate {
  color: #ba68c8 !important;
}

body[data-theme="dark"] .section-title .bi-shield-check {
  color: #90a4ae !important;
}

/* Tema scuro per altri elementi */
body[data-theme="dark"] .missing-field {
  border: 2px solid #dc3545 !important;
  background-color: #721c24 !important;
}

body[data-theme="dark"] .missing-fields-summary {
  background-color: #721c24;
  border: 1px solid #b02a37;
  color: #f8f9fa;
}

body[data-theme="dark"] .validation-error {
  color: #dc3545;
}

body[data-theme="dark"] .alert-info {
  background-color: #0c4a6e;
  border-color: #0369a1;
  color: #e0f2fe;
}

body[data-theme="dark"] .form-check.border.rounded.bg-light {
  background-color: #343a40 !important;
  border-color: #495057 !important;
  color: #f8f9fa !important;
}
</style>

<div class="d-flex justify-content-center">
  <div class="card p-4 my-5" style="width: 100%; max-width: 900px;">
    <h2 class="mb-4 text-center">{{ form.name }}</h2>
    
    <!-- Sommario campi mancanti -->
    <div id="missingFieldsSummary" class="missing-fields-summary">
      <h5><i class="bi bi-exclamation-triangle"></i> Campi Obbligatori Mancanti:</h5>
      <ul id="missingFieldsList"></ul>
      <p class="mb-0"><small>I campi contrassegnati con <span class="text-danger">*</span> sono obbligatori.</small></p>
    </div>
    
    <div class="step-indicator mb-4">
      <div class="step active" id="step-ind-1">1</div>
      <div class="step" id="step-ind-2">2</div>
      <div class="step" id="step-ind-3">3</div>
    </div>
    <form id="candidateForm" enctype="multipart/form-data" method="post">
      <!-- Campo nascosto per l'ID del form -->
      <input type="hidden" name="form_id" value="{{ form.id }}">
      
      <!-- Step 1: Dati anagrafici -->
      <div class="form-step active" id="step-1">
        
        <!-- Sezione Dati Personali -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-person"></i>
              Informazioni Personali
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="first_name" class="form-label required-field">Nome</label>
                  <input type="text" class="form-control" id="first_name" name="first_name" required>
                </div>
                <div class="mb-3">
                  <label for="last_name" class="form-label required-field">Cognome</label>
                  <input type="text" class="form-control" id="last_name" name="last_name" required>
                </div>
                <div class="mb-3">
                  <label for="gender" class="form-label required-field">Genere</label>
                  <select class="form-select" id="gender" name="gender" required>
                    <option value="">Seleziona</option>
                    {% for opt in dropdown_options.gender or ['M','F','Altro'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="date_of_birth" class="form-label required-field">Data di Nascita</label>
                  <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                </div>
                <div class="mb-3">
                  <label for="place_of_birth" class="form-label required-field">Luogo di Nascita</label>
                  <input type="text" class="form-control" id="place_of_birth" name="place_of_birth" required>
                </div>
                <div class="mb-3">
                  <label for="nationality" class="form-label required-field">Nazionalit√†</label>
                  <input type="text" class="form-control" id="nationality" name="nationality" required>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Stato Civile e Contatti -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-heart"></i>
              Stato Civile e Contatti
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="marital_status" class="form-label required-field">Stato Civile</label>
                  <select class="form-select" id="marital_status" name="marital_status" required>
                    <option value="">Seleziona</option>
                    {% for opt in dropdown_options.marital_status or ['Celibe/Nubile','Sposato/a','Divorziato/a','Vedovo/a'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="phone_number" class="form-label required-field">Numero di Telefono</label>
                  <input type="text" class="form-control" id="phone_number" name="phone_number" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="email" class="form-label required-field">Indirizzo Email</label>
                  <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="mb-3">
                  <label for="come_sei_arrivato" class="form-label required-field">Come sei arrivato a noi</label>
                  <select class="form-select" id="come_sei_arrivato" name="come_sei_arrivato" required>
                    <option value="">Seleziona</option>
                    {% for opt in dropdown_options.come_sei_arrivato or ['Passaparola','Social Media','Sito Web','Altro'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Caratteristiche Fisiche -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-rulers"></i>
              Caratteristiche Fisiche
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="height_cm" class="form-label required-field">Altezza (cm)</label>
                  <input type="number" class="form-control" id="height_cm" name="height_cm" min="120" max="220" required>
                </div>
                <div class="mb-3">
                  <label for="weight_kg" class="form-label required-field">Peso (kg)</label>
                  <input type="number" class="form-control" id="weight_kg" name="weight_kg" min="40" max="200" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="tshirt_size" class="form-label required-field">Taglia T-shirt</label>
                  <select class="form-select" id="tshirt_size" name="tshirt_size" required>
                    <option value="">Seleziona</option>
                    {% for opt in dropdown_options.tshirt_size or ['S','M','L','XL','XXL'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="shoe_size_eu" class="form-label required-field">Numero Scarpe (EU)</label>
                  <input type="text" class="form-control" id="shoe_size_eu" name="shoe_size_eu" placeholder="Es: 42, 38.5" required>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Foto Profilo -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-camera"></i>
              Foto Profilo
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label class="form-label required-field">Immagine Profilo</label>
                  <div class="btn-group mb-2" role="group">
                    <input type="radio" class="btn-check" name="photo_mode" id="photo_mode_upload" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="photo_mode_upload">Carica file</label>
                    <input type="radio" class="btn-check" name="photo_mode" id="photo_mode_camera" autocomplete="off">
                    <label class="btn btn-outline-primary" for="photo_mode_camera">Scatta foto</label>
                  </div>
                  <div id="photo_upload_area">
                    <div id="upload_instructions_area" class="alert alert-info">
                      <p><strong>Prima di caricare la foto, leggi le istruzioni!</strong></p>
                      <button type="button" class="btn btn-primary btn-sm" id="showInstructionsUploadBtn">Visualizza Istruzioni Foto</button>
                    </div>
                    <div id="upload_ready_area" style="display:none;">
                      <input type="file" class="form-control" id="profile_photo" name="profile_photo" accept="image/*" required>
                    </div>
                  </div>
                  <div id="photo_camera_area" style="display:none;">
                    <div id="camera_instructions_area" class="alert alert-info">
                      <p><strong>Prima di scattare la foto, leggi le istruzioni!</strong></p>
                      <button type="button" class="btn btn-primary btn-sm" id="showInstructionsBtn">Visualizza Istruzioni Foto</button>
                    </div>
                    <div id="camera_ready_area" style="display:none;">
                      <video id="profile_photo_video" width="200" height="150" autoplay style="border-radius:8px;"></video>
                      <button type="button" class="btn btn-secondary btn-sm mt-2" id="takePhotoBtn">Scatta</button>
                      <canvas id="profile_photo_canvas" width="200" height="150" style="display:none;"></canvas>
                    </div>
                  </div>
                  <div class="mt-2">
                    <img id="profile_photo_preview" src="" alt="Anteprima foto" class="rounded shadow" style="max-width:100px; max-height:100px; display:none;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-primary" id="next1">Avanti &rarr;</button>
        </div>
      </div>
      <!-- Step 2: Documenti e patente -->
      <div class="form-step" id="step-2">
        
        <!-- Sezione Residenza -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-geo-alt"></i>
              Informazioni di Residenza
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="address" class="form-label required-field">Indirizzo</label>
                  <input type="text" class="form-control" id="address" name="address" required>
                </div>
                <div class="mb-3">
                  <label for="city" class="form-label required-field">Citt√†</label>
                  <input type="text" class="form-control" id="city" name="city" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="postal_code" class="form-label required-field">Codice Postale</label>
                  <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                </div>
                <div class="mb-3">
                  <label for="country_of_residence" class="form-label required-field">Paese di Residenza</label>
                  <input type="text" class="form-control" id="country_of_residence" name="country_of_residence" required>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Documento d'Identit√† -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-person-badge"></i>
              Documento d'Identit√†
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_document" class="form-label required-field">Tipo Documento</label>
                  <select class="form-select" id="id_document" name="id_document" required>
                    <option value="">Seleziona</option>
                    {% for opt in dropdown_options.id_document or ['Carta identit√†','Passaporto','Permesso di soggiorno','Codice Fiscale'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="id_number" class="form-label required-field">Numero Documento</label>
                  <input type="text" class="form-control" id="id_number" name="id_number" required>
                </div>
                <div class="mb-3">
                  <label for="id_expiry_date" class="form-label required-field">Scadenza Documento</label>
                  <input type="date" class="form-control" id="id_expiry_date" name="id_expiry_date" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_country" class="form-label required-field">Paese Documento</label>
                  <input type="text" class="form-control" id="id_country" name="id_country" required>
                </div>
                <div class="mb-3">
                  <label for="additional_document" class="form-label">Documento Aggiuntivo</label>
                  <input type="text" class="form-control" id="additional_document" name="additional_document" placeholder="Es: Tessera sanitaria, Carta regionale servizi, ecc.">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Documenti Fiscali -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-file-earmark-text"></i>
              Documenti Fiscali e Legali
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="codice_fiscale" class="form-label required-field">Codice Fiscale</label>
                  <input type="text" class="form-control" id="codice_fiscale" name="codice_fiscale" placeholder="Es: RSSMRA85M01H501Z" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="permesso_soggiorno" class="form-label">Numero Permesso di Soggiorno</label>
                  <input type="text" class="form-control" id="permesso_soggiorno" name="permesso_soggiorno" placeholder="Es: 123456789">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Patente di Guida -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-credit-card"></i>
              Patente di Guida
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="license_country" class="form-label required-field">Paese Patente</label>
                  <input type="text" class="form-control" id="license_country" name="license_country" required>
                </div>
                <div class="mb-3">
                  <label for="license_number" class="form-label required-field">Numero Patente</label>
                  <input type="text" class="form-control" id="license_number" name="license_number" required>
                </div>
                <div class="mb-3">
                  <label for="license_category" class="form-label required-field">Categoria Patente</label>
                  <input type="text" class="form-control" id="license_category" name="license_category" placeholder="Es: B, C, D, BE" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="license_issue_date" class="form-label required-field">Data Rilascio Patente</label>
                  <input type="date" class="form-control" id="license_issue_date" name="license_issue_date" required>
                </div>
                <div class="mb-3">
                  <label for="license_expiry_date" class="form-label required-field">Scadenza Patente</label>
                  <input type="date" class="form-control" id="license_expiry_date" name="license_expiry_date" required>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Esperienza di Guida e Documenti -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-car-front"></i>
              Esperienza di Guida
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="years_driving_experience" class="form-label required-field">Anni di Esperienza di Guida</label>
                  <input type="number" class="form-control" id="years_driving_experience" name="years_driving_experience" min="0" max="70" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="auto_moto_munito" class="form-label required-field">Auto/Moto Munito</label>
                  <select class="form-select" id="auto_moto_munito" name="auto_moto_munito" required>
                    <option value="">Seleziona</option>
                    <option value="1">S√¨</option>
                    <option value="0">No</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Upload Documenti -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-file-arrow-up"></i>
              Upload Curriculum
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="curriculum_file" class="form-label required-field">Curriculum (PDF/DOCX)</label>
                  <input type="file" class="form-control" id="curriculum_file" name="curriculum_file" accept=".pdf,.doc,.docx" required>
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> 
                    Carica il tuo curriculum in formato PDF o DOCX (massimo 10MB)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" id="prev2">&larr; Indietro</button>
          <button type="button" class="btn btn-primary" id="next2">Avanti &rarr;</button>
        </div>
      </div>
      <!-- Step 3: Esperienze e lingue -->
      <div class="form-step" id="step-3">
        
        <!-- Sezione Esperienza Lavorativa -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-briefcase"></i>
              Esperienza Lavorativa
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="occupation" class="form-label required-field">Occupazione</label>
                  <input type="text" class="form-control" id="occupation" name="occupation" placeholder="Es: Ingegnere, Studente, Manager" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="other_experience" class="form-label required-field">Altre Esperienze</label>
                  <textarea class="form-control" id="other_experience" name="other_experience" rows="4" placeholder="Descrivi brevemente le tue esperienze lavorative, competenze e qualifiche rilevanti..." required></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Disponibilit√† -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-calendar-check"></i>
              Disponibilit√† Lavorativa
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="availability_from" class="form-label required-field">Disponibilit√† Da</label>
                  <input type="date" class="form-control" id="availability_from" name="availability_from" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="availability_till" class="form-label required-field">Disponibilit√† Fino A</label>
                  <input type="date" class="form-control" id="availability_till" name="availability_till" required>
                </div>
              </div>
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="other_location" class="form-label required-field">Citt√† di Disponibilit√†</label>
                  <input type="text" class="form-control" id="other_location" name="other_location" required placeholder="Es: Milano, Roma, Torino o disponibile per trasferte">
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> 
                    Indica le citt√† dove sei disponibile a lavorare o se sei disponibile per trasferte
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sezione Competenze Linguistiche -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-translate"></i>
              Competenze Linguistiche
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="language_1" class="form-label required-field">Prima Lingua</label>
                  <input type="text" class="form-control" id="language_1" name="language_1" placeholder="Es: Italiano" required>
                </div>
                <div class="mb-3">
                  <label for="proficiency_1" class="form-label required-field">Livello Prima Lingua</label>
                  <select class="form-select" id="proficiency_1" name="proficiency_1" required>
                    <option value="">Seleziona livello</option>
                    {% for opt in dropdown_options.proficiency_1 or ['Base','Intermedio','Avanzato','Madrelingua'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="language_2" class="form-label required-field">Seconda Lingua</label>
                  <input type="text" class="form-control" id="language_2" name="language_2" placeholder="Es: Inglese" required>
                </div>
                <div class="mb-3">
                  <label for="proficiency_2" class="form-label required-field">Livello Seconda Lingua</label>
                  <select class="form-select" id="proficiency_2" name="proficiency_2" required>
                    <option value="">Seleziona livello</option>
                    {% for opt in dropdown_options.proficiency_2 or ['Base','Intermedio','Avanzato','Madrelingua'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="language_3" class="form-label required-field">Terza Lingua</label>
                  <input type="text" class="form-control" id="language_3" name="language_3" placeholder="Es: Francese, Spagnolo" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="proficiency_3" class="form-label required-field">Livello Terza Lingua</label>
                  <select class="form-select" id="proficiency_3" name="proficiency_3" required>
                    <option value="">Seleziona livello</option>
                    {% for opt in dropdown_options.proficiency_3 or ['Base','Intermedio','Avanzato','Madrelingua'] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sezione Consenso Privacy -->
        <div class="form-section">
          <div class="section-header">
            <h5 class="section-title">
              <i class="bi bi-shield-check"></i>
              Consenso al Trattamento Dati
            </h5>
          </div>
          <div class="section-body">
            <div class="row">
              <div class="col-12">
                <div class="mb-3">
                  <div class="form-check p-3 border rounded bg-light">
                    <input class="form-check-input" type="checkbox" id="gdpr_consent" name="gdpr_consent" required>
                    <label class="form-check-label required-field" for="gdpr_consent">
                      <strong>ACCONSENTE</strong> ai sensi e per gli effetti degli artt. 13 e 23 del D. Lgs. n. 196/2003, con la sottoscrizione del presente modulo, al trattamento dei dati personali secondo le modalit√† e nei limiti di cui all'informativa allegata. <span class="text-danger">*</span>
                    </label>
                  </div>
                  <!-- Link Privacy (inserito dinamicamente da JavaScript) -->
                  <div id="privacy-link-container" class="mt-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" id="prev3">&larr; Indietro</button>
          <button type="submit" class="btn btn-success">Invia candidatura</button>
        </div>
      </div>
    </form>
    <div id="form-success" class="alert alert-success mt-3 d-none">Candidatura inviata con successo!</div>
    <div id="form-error" class="alert alert-danger mt-3 d-none"></div>
    <div id="form-loading" class="d-none text-center my-4">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Caricamento...</span>
      </div>
      <div class="mt-2">Invio candidatura in corso...</div>
    </div>
  </div>
</div>

<!-- Modal Istruzioni Foto -->
<div class="modal fade" id="photoInstructionsModal" tabindex="-1" aria-labelledby="photoInstructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="photoInstructionsModalLabel">
          <i class="bi bi-camera"></i> Istruzioni per la Foto Profilo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <p class="lead">Leggi attentamente le istruzioni per una foto di qualit√† professionale</p>
        </div>
        
        <!-- PDF Iframe -->
        <div class="ratio ratio-16x9 mb-4">
          <iframe 
            src="https://w3data.blob.core.windows.net/public-docs/Istruzioni_foto_2.pdf" 
            title="Istruzioni Foto PDF"
            style="border: 1px solid #dee2e6; border-radius: 0.375rem;">
          </iframe>
        </div>
        
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Importante:</strong> Assicurati di seguire tutte le indicazioni del documento per ottenere una foto di qualit√† professionale, sia che tu la stia scattando che caricando.
        </div>
        
        <div class="text-center">
          <h5 class="mb-3">Hai letto e compreso le istruzioni?</h5>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-success btn-lg" id="confirmInstructionsBtn">
              <i class="bi bi-check-circle"></i> S√¨, ho capito
            </button>
            <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
              <i class="bi bi-arrow-left"></i> Rileggi le istruzioni
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
// CONFIGURAZIONE TEST - Ora dinamica dal backend
const DISABLE_REQUIRED_VALIDATION = {{ test_mode|tojson }}; // Modalit√† test globale controllata dal pannello sviluppatore

// CONFIGURAZIONE CAMPI DINAMICI - Caricata dal backend
let FIELD_VISIBILITY_CONFIG = {};

// CONFIGURAZIONE PRIVACY LINK - Ora caricata dinamicamente dall'API
let PRIVACY_LINK_CONFIG = {
  enabled: false,
  url: '',
  text: 'Leggi l\'informativa completa sulla privacy',
  openInNewTab: true
};

// Ottieni slug del form dalla URL o dai dati del template
const FORM_SLUG = '{{ form.slug }}';

// Gestione step form
const steps = document.querySelectorAll('.form-step');
const indicators = document.querySelectorAll('.step-indicator .step');
let currentStep = 0;

// Lista di tutti i campi obbligatori
const requiredFields = [
  'first_name', 'last_name', 'gender', 'date_of_birth', 'place_of_birth', 
  'nationality', 'marital_status', 'come_sei_arrivato', 'height_cm', 'weight_kg', 
  'tshirt_size', 'shoe_size_eu', 'phone_number', 'email', 'profile_photo',
  'address', 'city', 'postal_code', 'country_of_residence', 'id_document', 
  'id_number', 'id_expiry_date', 'id_country', 'codice_fiscale',
  'license_country', 'license_number', 'license_category', 'license_issue_date', 
  'license_expiry_date', 'years_driving_experience', 'auto_moto_munito', 'curriculum_file',
  'occupation', 'other_experience', 'availability_from', 'availability_till', 'other_location', 
  'language_1', 'proficiency_1', 'language_2', 'proficiency_2', 'language_3', 'proficiency_3',
  'gdpr_consent'
];

// Mappatura dei nomi dei campi in italiano
const fieldLabels = {
  'first_name': 'Nome',
  'last_name': 'Cognome',
  'gender': 'Genere',
  'date_of_birth': 'Data di Nascita',
  'place_of_birth': 'Luogo di Nascita',
  'nationality': 'Nazionalit√†',
  'marital_status': 'Stato Civile',
  'come_sei_arrivato': 'Come sei arrivato a noi',
  'height_cm': 'Altezza (cm)',
  'weight_kg': 'Peso (kg)',
  'tshirt_size': 'Taglia T-shirt',
  'shoe_size_eu': 'Numero Scarpe (EU)',
  'phone_number': 'Numero di Telefono',
  'email': 'Indirizzo Email',
  'profile_photo': 'Immagine Profilo',
  'address': 'Indirizzo',
  'city': 'Citt√†',
  'postal_code': 'Codice Postale',
  'country_of_residence': 'Paese di Residenza',
  'id_document': 'Tipo Documento',
  'id_number': 'Numero Documento',
  'id_expiry_date': 'Scadenza Documento',
  'id_country': 'Paese Documento',
  'codice_fiscale': 'Codice Fiscale',
  'permesso_soggiorno': 'Numero Permesso di Soggiorno',
  'license_country': 'Paese Patente',
  'license_number': 'Numero Patente',
  'license_category': 'Drive License',
  'license_issue_date': 'Data Rilascio Patente',
  'license_expiry_date': 'Scadenza Patente',
  'years_driving_experience': 'Anni di Esperienza di Guida',
  'auto_moto_munito': 'Auto/Moto Munito',
  'curriculum_file': 'Curriculum',
  'occupation': 'Occupazione',
  'other_experience': 'Altre Esperienze',
  'availability_from': 'Disponibilit√† Da',
  'availability_till': 'Disponibilit√† Fino A',
  'other_location': 'City/Cities of Availability',
  'language_1': 'Lingua 1',
  'proficiency_1': 'Livello 1',
  'language_2': 'Lingua 2',
  'proficiency_2': 'Livello 2',
  'language_3': 'Lingua 3',
  'proficiency_3': 'Livello 3',
  'gdpr_consent': 'Consenso al trattamento dei dati personali'
};

function validateField(fieldId) {
  const field = document.getElementById(fieldId);
  if (!field) return true;
  
  // Se la validazione √® disabilitata per i test, considera tutti i campi validi
  if (DISABLE_REQUIRED_VALIDATION) {
    field.classList.remove('missing-field');
    return true;
  }
  
  let isValid = true;
  
  if (field.type === 'file') {
    // Per il campo foto, considera anche la foto scattata con webcam
    if (fieldId === 'profile_photo') {
      if (photoModeCamera.checked) {
        // Se √® in modalit√† camera, deve aver confermato le istruzioni e scattato la foto
        isValid = instructionsConfirmed && capturedPhotoBlob;
      } else {
        // Se √® in modalit√† upload, deve aver confermato le istruzioni e selezionato un file
        isValid = instructionsConfirmed && field.files && field.files.length > 0;
      }
    } else {
      isValid = field.files && field.files.length > 0;
    }
  } else if (field.tagName === 'SELECT') {
    isValid = field.value !== '';
  } else if (field.type === 'checkbox') {
    isValid = field.checked;
  } else {
    isValid = field.value.trim() !== '';
  }
  
  // Aggiungi/rimuovi la classe per evidenziare i campi mancanti
  if (isValid) {
    field.classList.remove('missing-field');
  } else {
    field.classList.add('missing-field');
  }
  
  return isValid;
}

function validateCurrentStep() {
  // Se la validazione √® disabilitata per i test, considera sempre valido
  if (DISABLE_REQUIRED_VALIDATION) {
    return true;
  }
  
  // Mappatura dei campi per step
  const stepFields = {
    0: ['first_name', 'last_name', 'gender', 'date_of_birth', 'place_of_birth', 
        'nationality', 'marital_status', 'come_sei_arrivato', 'height_cm', 'weight_kg', 
        'tshirt_size', 'shoe_size_eu', 'phone_number', 'email', 'profile_photo'],
    1: ['address', 'city', 'postal_code', 'country_of_residence', 'id_document', 
        'id_number', 'id_expiry_date', 'id_country', 'codice_fiscale',
        'license_country', 'license_number', 'license_category', 'license_issue_date', 
        'license_expiry_date', 'years_driving_experience', 'auto_moto_munito', 'curriculum_file'],
    2: ['occupation', 'other_experience', 'availability_from', 'availability_till', 'other_location', 
        'language_1', 'proficiency_1', 'language_2', 'proficiency_2', 'language_3', 'proficiency_3',
        'gdpr_consent']
  };
  
  const currentStepFields = stepFields[currentStep] || [];
  let allValid = true;
  
  // Filtra solo i campi che sono sia nello step corrente che nella lista dei campi obbligatori dinamici
  const requiredFieldsForCurrentStep = currentStepFields.filter(fieldId => {
    // Controlla se il campo √® nella configurazione dinamica e se √® obbligatorio e visibile
    if (FIELD_VISIBILITY_CONFIG && FIELD_VISIBILITY_CONFIG[fieldId]) {
      return FIELD_VISIBILITY_CONFIG[fieldId].is_visible && FIELD_VISIBILITY_CONFIG[fieldId].is_required;
    }
    // Se non c'√® configurazione dinamica, usa la lista statica requiredFields come fallback
    return requiredFields && requiredFields.includes(fieldId);
  });
  
  console.log(`üîç Validazione step ${currentStep}, campi obbligatori:`, requiredFieldsForCurrentStep);
  
  requiredFieldsForCurrentStep.forEach(fieldId => {
    if (!validateField(fieldId)) {
      allValid = false;
      console.log(`‚ùå Campo non valido: ${fieldId}`);
    } else {
      console.log(`‚úÖ Campo valido: ${fieldId}`);
    }
  });
  
  return allValid;
}

function showMissingFieldsSummary() {
  // Se la validazione √® disabilitata per i test, considera sempre valido
  if (DISABLE_REQUIRED_VALIDATION) {
    const summaryDiv = document.getElementById('missingFieldsSummary');
    summaryDiv.classList.remove('show');
    return true;
  }
  
  const missingFields = [];
  
  // Usa la configurazione dinamica se disponibile, altrimenti fallback alla lista statica
  let fieldsToCheck = [];
  
  if (FIELD_VISIBILITY_CONFIG) {
    // Filtra i campi che sono visibili e obbligatori dalla configurazione dinamica
    fieldsToCheck = Object.keys(FIELD_VISIBILITY_CONFIG).filter(fieldId => {
      const config = FIELD_VISIBILITY_CONFIG[fieldId];
      return config.is_visible && config.is_required;
    });
  } else if (requiredFields) {
    // Fallback alla lista statica
    fieldsToCheck = requiredFields;
  }
  
  console.log('üîç Controllo campi mancanti per:', fieldsToCheck);
  
  fieldsToCheck.forEach(fieldId => {
    if (!validateField(fieldId)) {
      missingFields.push(fieldLabels[fieldId] || fieldId);
      console.log(`‚ùå Campo mancante: ${fieldId}`);
    }
  });
  
  const summaryDiv = document.getElementById('missingFieldsSummary');
  const listEl = document.getElementById('missingFieldsList');
  
  if (missingFields.length > 0) {
    listEl.innerHTML = missingFields.map(field => `<li>${field}</li>`).join('');
    summaryDiv.classList.add('show');
    
    // Scroll alla summary
    summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    summaryDiv.classList.remove('show');
  }
  
  return missingFields.length === 0;
}

function showStep(idx) {
  steps.forEach((s, i) => s.classList.toggle('active', i === idx));
  indicators.forEach((el, i) => el.classList.toggle('active', i === idx));
  currentStep = idx;
  
  // Nascondi il sommario quando cambi step
  document.getElementById('missingFieldsSummary').classList.remove('show');
}

function nextStep() {
  if (validateCurrentStep()) {
    if (currentStep < steps.length - 1) {
      showStep(currentStep + 1);
    }
  } else {
    // Mostra un messaggio pi√π dettagliato con i campi mancanti
    showMissingFieldsAlert();
  }
}

function showMissingFieldsAlert() {
  // Mappatura dei campi per step
  const stepFields = {
    0: ['first_name', 'last_name', 'gender', 'date_of_birth', 'place_of_birth', 
        'nationality', 'marital_status', 'come_sei_arrivato', 'height_cm', 'weight_kg', 
        'tshirt_size', 'shoe_size_eu', 'phone_number', 'email', 'profile_photo'],
    1: ['address', 'city', 'postal_code', 'country_of_residence', 'id_document', 
        'id_number', 'id_expiry_date', 'id_country', 'codice_fiscale',
        'license_country', 'license_number', 'license_category', 'license_issue_date', 
        'license_expiry_date', 'years_driving_experience', 'auto_moto_munito', 'curriculum_file'],
    2: ['occupation', 'other_experience', 'availability_from', 'availability_till', 'other_location', 
        'language_1', 'proficiency_1', 'language_2', 'proficiency_2', 'language_3', 'proficiency_3',
        'gdpr_consent']
  };
  
  const currentStepFields = stepFields[currentStep] || [];
  const missingFields = [];
  
  // Filtra solo i campi che sono sia nello step corrente che nella lista dei campi obbligatori dinamici
  const requiredFieldsForCurrentStep = currentStepFields.filter(fieldId => {
    if (FIELD_VISIBILITY_CONFIG && FIELD_VISIBILITY_CONFIG[fieldId]) {
      return FIELD_VISIBILITY_CONFIG[fieldId].is_visible && FIELD_VISIBILITY_CONFIG[fieldId].is_required;
    }
    return requiredFields && requiredFields.includes(fieldId);
  });
  
  requiredFieldsForCurrentStep.forEach(fieldId => {
    if (!validateField(fieldId)) {
      missingFields.push(fieldLabels[fieldId] || fieldId);
    }
  });
  
  if (missingFields.length > 0) {
    const message = `Per favore, compila i seguenti campi obbligatori prima di continuare:\n\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}`;
    alert(message);
  } else {
    alert('Per favore, compila tutti i campi obbligatori prima di continuare.');
  }
}

// Event listeners per i pulsanti di navigazione
document.getElementById('next1').onclick = nextStep;
document.getElementById('next2').onclick = nextStep;
document.getElementById('prev2').onclick = () => showStep(0);
document.getElementById('prev3').onclick = () => showStep(1);

// Gestione upload/scatto foto profilo
const photoModeUpload = document.getElementById('photo_mode_upload');
const photoModeCamera = document.getElementById('photo_mode_camera');
const photoUploadArea = document.getElementById('photo_upload_area');
const photoCameraArea = document.getElementById('photo_camera_area');
const uploadInstructionsArea = document.getElementById('upload_instructions_area');
const uploadReadyArea = document.getElementById('upload_ready_area');
const cameraInstructionsArea = document.getElementById('camera_instructions_area');
const cameraReadyArea = document.getElementById('camera_ready_area');
const profilePhotoFile = document.getElementById('profile_photo');
const profilePhotoVideo = document.getElementById('profile_photo_video');
const profilePhotoCanvas = document.getElementById('profile_photo_canvas');
const profilePhotoPreview = document.getElementById('profile_photo_preview');
const showInstructionsBtn = document.getElementById('showInstructionsBtn');
const showInstructionsUploadBtn = document.getElementById('showInstructionsUploadBtn');
const confirmInstructionsBtn = document.getElementById('confirmInstructionsBtn');
let webcamStream = null;
let capturedPhotoBlob = null;
let instructionsConfirmed = false;

photoModeUpload.addEventListener('change', function() {
  if(this.checked) {
    photoUploadArea.style.display = 'block';
    photoCameraArea.style.display = 'none';
    uploadInstructionsArea.style.display = 'block';
    uploadReadyArea.style.display = 'none';
    profilePhotoPreview.style.display = 'none';
    capturedPhotoBlob = null;
    instructionsConfirmed = false;
    stopWebcam();
    // Rivalidare il campo foto
    validateField('profile_photo');
  }
});

photoModeCamera.addEventListener('change', function() {
  if(this.checked) {
    photoUploadArea.style.display = 'none';
    photoCameraArea.style.display = 'block';
    cameraInstructionsArea.style.display = 'block';
    cameraReadyArea.style.display = 'none';
    profilePhotoPreview.style.display = 'none';
    capturedPhotoBlob = null;
    instructionsConfirmed = false;
    stopWebcam();
  }
});

// Gestione modal istruzioni
showInstructionsBtn.addEventListener('click', function() {
  const modal = new bootstrap.Modal(document.getElementById('photoInstructionsModal'));
  modal.show();
});

// Gestione modal istruzioni per upload
showInstructionsUploadBtn.addEventListener('click', function() {
  const modal = new bootstrap.Modal(document.getElementById('photoInstructionsModal'));
  modal.show();
});

confirmInstructionsBtn.addEventListener('click', function() {
  instructionsConfirmed = true;
  
  // Chiudi il modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('photoInstructionsModal'));
  modal.hide();
  
  // Controlla quale modalit√† √® attiva
  if (photoModeCamera.checked) {
    // Modalit√† camera: nascondi le istruzioni e mostra la webcam
    cameraInstructionsArea.style.display = 'none';
    cameraReadyArea.style.display = 'block';
    
    // Avvia la webcam
    startWebcam();
  } else if (photoModeUpload.checked) {
    // Modalit√† upload: nascondi le istruzioni e mostra il campo file
    uploadInstructionsArea.style.display = 'none';
    uploadReadyArea.style.display = 'block';
  }
  
  // Rivalidare il campo foto quando le istruzioni sono confermate
  setTimeout(() => validateField('profile_photo'), 100);
});

function startWebcam() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      webcamStream = stream;
      profilePhotoVideo.srcObject = stream;
      profilePhotoVideo.play();
    })
    .catch(() => {
      alert('Impossibile accedere alla webcam.');
    });
}

function stopWebcam() {
  if (webcamStream) {
    webcamStream.getTracks().forEach(track => track.stop());
    webcamStream = null;
  }
  profilePhotoVideo.srcObject = null;
}

document.getElementById('takePhotoBtn').addEventListener('click', function() {
  profilePhotoCanvas.width = profilePhotoVideo.videoWidth;
  profilePhotoCanvas.height = profilePhotoVideo.videoHeight;
  profilePhotoCanvas.getContext('2d').drawImage(profilePhotoVideo, 0, 0);
  profilePhotoCanvas.toBlob(blob => {
    capturedPhotoBlob = blob;
    const url = URL.createObjectURL(blob);
    profilePhotoPreview.src = url;
    profilePhotoPreview.style.display = 'block';
    // Rivalidare il campo foto dopo aver scattato
    validateField('profile_photo');
  }, 'image/jpeg');
});

profilePhotoFile.addEventListener('change', function() {
  const file = this.files[0];
  if(file) {
    const url = URL.createObjectURL(file);
    profilePhotoPreview.src = url;
    profilePhotoPreview.style.display = 'block';
    capturedPhotoBlob = null;
  }
  // Rivalidare il campo foto dopo il caricamento
  validateField('profile_photo');
});

// Aggiungi validazione in tempo reale
requiredFields.forEach(fieldId => {
  const field = document.getElementById(fieldId);
  if (field) {
    field.addEventListener('change', () => validateField(fieldId));
    field.addEventListener('input', () => validateField(fieldId));
  }
});

// Funzione per creare FormData filtrato con solo i campi visibili
function createFilteredFormData(form) {
  const formData = new FormData();
  const originalFormData = new FormData(form);
  let visibleFieldsCount = 0;
  let totalFieldsCount = 0;
  
  // Itera attraverso tutti i campi del form originale
  for (let [fieldName, value] of originalFormData.entries()) {
    totalFieldsCount++;
    
    // Controlla se il campo √® visibile nella configurazione
    let isVisible = true; // Default: visibile se non c'√® configurazione
    
    if (FIELD_VISIBILITY_CONFIG && FIELD_VISIBILITY_CONFIG[fieldName]) {
      isVisible = FIELD_VISIBILITY_CONFIG[fieldName].is_visible;
    }
    
    if (isVisible) {
      formData.append(fieldName, value);
      visibleFieldsCount++;
      console.log(`‚úÖ Campo incluso: ${fieldName}`);
    } else {
      console.log(`üö´ Campo escluso (nascosto): ${fieldName}`);
    }
  }
  
  console.log(`üìä Invio dati: ${visibleFieldsCount}/${totalFieldsCount} campi inclusi`);
  
  return formData;
}

// Funzione di validazione completa per il submit finale
function validateFormForSubmit() {
  // Se la validazione √® disabilitata per i test, considera sempre valido
  if (DISABLE_REQUIRED_VALIDATION) {
    return true;
  }
  
  const missingFields = [];
  let fieldsToCheck = [];
  
  // Usa la configurazione dinamica se disponibile
  if (FIELD_VISIBILITY_CONFIG) {
    fieldsToCheck = Object.keys(FIELD_VISIBILITY_CONFIG).filter(fieldId => {
      const config = FIELD_VISIBILITY_CONFIG[fieldId];
      return config.is_visible && config.is_required;
    });
    console.log('üîç Validazione submit con configurazione dinamica:', fieldsToCheck);
  } else if (requiredFields) {
    // Fallback alla lista statica
    fieldsToCheck = requiredFields;
    console.log('üîç Validazione submit con lista statica:', fieldsToCheck);
  }
  
  fieldsToCheck.forEach(fieldId => {
    if (!validateField(fieldId)) {
      const fieldLabel = fieldLabels[fieldId] || fieldId;
      missingFields.push(fieldLabel);
      console.log(`‚ùå Campo obbligatorio mancante: ${fieldId} (${fieldLabel})`);
    }
  });
  
  if (missingFields.length > 0) {
    const message = `Per favore, compila i seguenti campi obbligatori prima di inviare la candidatura:\n\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}`;
    alert(message);
    
    // Mostra anche il sommario visuale
    const summaryDiv = document.getElementById('missingFieldsSummary');
    const listEl = document.getElementById('missingFieldsList');
    if (summaryDiv && listEl) {
      listEl.innerHTML = missingFields.map(field => `<li>${field}</li>`).join('');
      summaryDiv.classList.add('show');
      summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    return false;
  }
  
  console.log('‚úÖ Validazione submit completata con successo');
  return true;
}

// Modifica invio form per includere foto scattata e validazione
const form = document.getElementById('candidateForm');
form.onsubmit = async function(e) {
  e.preventDefault();
  
  // Valida tutti i campi obbligatori usando la configurazione dinamica
  if (!validateFormForSubmit()) {
    return;
  }
  
  document.getElementById('form-error').classList.add('d-none');
  document.getElementById('form-success').classList.add('d-none');
  document.getElementById('form-loading').classList.remove('d-none');
  const submitBtn = form.querySelector('[type="submit"]');
  if(submitBtn) submitBtn.disabled = true;
  
  try {
    // Crea FormData filtrato con solo i campi visibili
    const formData = createFilteredFormData(form);
    
    // Aggiungi la foto scattata se presente e se il campo √® visibile
    if(photoModeCamera.checked && capturedPhotoBlob) {
      const profilePhotoVisible = FIELD_VISIBILITY_CONFIG && 
                                  FIELD_VISIBILITY_CONFIG['profile_photo'] ? 
                                  FIELD_VISIBILITY_CONFIG['profile_photo'].is_visible : true;
      if (profilePhotoVisible) {
        formData.set('profile_photo', capturedPhotoBlob, 'profile_photo.jpg');
        console.log('üì∑ Foto scattata aggiunta ai dati (campo visibile)');
      } else {
        console.log('üö´ Foto scattata non aggiunta (campo nascosto)');
      }
    }
    
    const resp = await fetch('/api/candidates/upload', {
      method: 'POST',
      body: formData
    });
    const data = await resp.json();
    
    document.getElementById('form-loading').classList.add('d-none');
    if(submitBtn) submitBtn.disabled = false;
    
    if(data.success) {
      window.location.href = '/success';
    } else {
      document.getElementById('form-error').textContent = data.error || 'Errore invio candidatura';
      document.getElementById('form-error').classList.remove('d-none');
    }
  } catch (err) {
    document.getElementById('form-loading').classList.add('d-none');
    if(submitBtn) submitBtn.disabled = false;
    document.getElementById('form-error').textContent = 'Errore di rete o server';
    document.getElementById('form-error').classList.remove('d-none');
  }
  
  stopWebcam();
};

// Funzione per inizializzare il link alla privacy
function initPrivacyLink() {
  const container = document.getElementById('privacy-link-container');
  
  if (PRIVACY_LINK_CONFIG.enabled && PRIVACY_LINK_CONFIG.url && container) {
    const linkElement = document.createElement('a');
    linkElement.href = PRIVACY_LINK_CONFIG.url;
    linkElement.textContent = PRIVACY_LINK_CONFIG.text;
    linkElement.className = 'text-primary text-decoration-underline';
    
    if (PRIVACY_LINK_CONFIG.openInNewTab) {
      linkElement.target = '_blank';
      linkElement.rel = 'noopener noreferrer';
    }
    
    // Aggiungi icona se apre in nuova tab
    if (PRIVACY_LINK_CONFIG.openInNewTab) {
      const icon = document.createElement('i');
      icon.className = 'bi bi-box-arrow-up-right ms-1';
      icon.style.fontSize = '0.8em';
      linkElement.appendChild(icon);
    }
    
    // Crea il wrapper per il link
    const wrapper = document.createElement('div');
    wrapper.className = 'text-center';
    wrapper.appendChild(linkElement);
    
    container.appendChild(wrapper);
    
    console.log('‚úÖ Link privacy inizializzato:', PRIVACY_LINK_CONFIG.url);
  } else if (!PRIVACY_LINK_CONFIG.enabled) {
    console.log('‚ÑπÔ∏è Link privacy disabilitato dalla configurazione del form');
  }
}

// Funzione per caricare la configurazione di visibilit√† dei campi dall'API
async function loadFieldVisibilityConfig() {
  try {
    console.log('üîÑ Caricamento configurazione campi per form:', FORM_SLUG);
    
    const response = await fetch(`/api/form/${FORM_SLUG}/field-visibility`);
    
    if (!response.ok) {
      console.warn('‚ö†Ô∏è Impossibile caricare la configurazione campi:', response.status);
      return;
    }
    
    const data = await response.json();
    
    if (data.success) {
      FIELD_VISIBILITY_CONFIG = data.field_visibility;
      console.log('‚úÖ Configurazione campi caricata:', FIELD_VISIBILITY_CONFIG);
      
      // Applica la configurazione ai campi
      applyFieldVisibilityConfig();
    } else {
      console.warn('‚ö†Ô∏è Errore nella risposta API:', data.error);
    }
    
  } catch (error) {
    console.error('‚ùå Errore nel caricamento configurazione campi:', error);
  }
}

// Funzione per applicare la configurazione di visibilit√† ai campi
function applyFieldVisibilityConfig() {
  Object.entries(FIELD_VISIBILITY_CONFIG).forEach(([fieldName, config]) => {
    const field = document.getElementById(fieldName);
    
    if (field) {
      // Trova il contenitore del campo (di solito un div con class mb-3)
      let fieldContainer = field.closest('.mb-3');
      
      // Per campi speciali come profile_photo che hanno strutture diverse
      if (!fieldContainer && fieldName === 'profile_photo') {
        fieldContainer = field.closest('.form-section');
      }
      
      if (fieldContainer) {
        // Gestisci visibilit√†
        if (!config.is_visible) {
          fieldContainer.style.display = 'none';
          console.log(`üôà Campo nascosto: ${fieldName}`);
        } else {
          fieldContainer.style.display = '';
          console.log(`üëÅÔ∏è Campo visibile: ${fieldName}`);
        }
        
        // Gestisci obbligatoriet√†
        if (config.is_visible) {
          const label = fieldContainer.querySelector('label');
          const requiredSpan = label ? label.querySelector('.required-field::after, .text-danger') : null;
          
          if (config.is_required) {
            // Aggiungi classe required-field se non presente
            if (label && !label.classList.contains('required-field')) {
              label.classList.add('required-field');
            }
            field.required = true;
            console.log(`‚ö†Ô∏è Campo obbligatorio: ${fieldName}`);
          } else {
            // Rimuovi classe required-field se presente
            if (label && label.classList.contains('required-field')) {
              label.classList.remove('required-field');
            }
            field.required = false;
            console.log(`üîπ Campo facoltativo: ${fieldName}`);
          }
        }
      }
    } else {
      console.warn(`‚ö†Ô∏è Campo non trovato nel DOM: ${fieldName}`);
    }
  });
  
  // Aggiorna la lista dei campi obbligatori dinamicamente
  updateRequiredFieldsList();
}

// Funzione per aggiornare la lista dei campi obbligatori basata sulla configurazione
function updateRequiredFieldsList() {
  const dynamicRequiredFields = [];
  
  Object.entries(FIELD_VISIBILITY_CONFIG).forEach(([fieldName, config]) => {
    if (config.is_visible && config.is_required) {
      dynamicRequiredFields.push(fieldName);
    }
  });
  
  // Aggiorna la lista globale requiredFields se esiste
  if (typeof requiredFields !== 'undefined') {
    // Sostituisci la lista esistente con quella dinamica
    requiredFields.length = 0;
    requiredFields.push(...dynamicRequiredFields);
    console.log('üìù Lista campi obbligatori aggiornata:', requiredFields);
  }
}

// Funzione per caricare le impostazioni privacy dall'API
async function loadPrivacySettings() {
  try {
    console.log('üîÑ Caricamento impostazioni privacy per form:', FORM_SLUG);
    
    const response = await fetch(`/api/form/${FORM_SLUG}/privacy-settings`);
    
    if (!response.ok) {
      console.warn('‚ö†Ô∏è Impossibile caricare le impostazioni privacy:', response.status);
      return;
    }
    
    const settings = await response.json();
    
    // Aggiorna la configurazione globale
    PRIVACY_LINK_CONFIG = {
      enabled: settings.enabled || false,
      url: settings.url || '',
      text: settings.text || 'Leggi l\'informativa completa sulla privacy',
      openInNewTab: settings.openInNewTab || true
    };
    
    console.log('‚úÖ Impostazioni privacy caricate:', PRIVACY_LINK_CONFIG);
    
    // Inizializza il link con le nuove impostazioni
    initPrivacyLink();
    
  } catch (error) {
    console.error('‚ùå Errore nel caricamento impostazioni privacy:', error);
  }
}

// Validazione iniziale
document.addEventListener('DOMContentLoaded', function() {
  // Nascondi il sommario all'inizio
  document.getElementById('missingFieldsSummary').classList.remove('show');
  
  // Carica la configurazione dei campi e applica visibilit√†/obbligatoriet√†
  loadFieldVisibilityConfig();
  
  // Carica le impostazioni privacy dall'API e inizializza il link
  loadPrivacySettings();
  
  // Log per modalit√† test
  if (DISABLE_REQUIRED_VALIDATION) {
    console.warn('‚ö†Ô∏è MODALIT√Ä TEST ATTIVA: La validazione dei campi obbligatori √® disabilitata!');
    console.warn('Per riabilitare la validazione, imposta DISABLE_REQUIRED_VALIDATION = false');
    
    // Aggiungi banner di avviso visuale
    const testBanner = document.createElement('div');
    testBanner.className = 'alert alert-warning alert-dismissible fade show';
    testBanner.style.marginBottom = '1rem';
    testBanner.innerHTML = `
      <strong><i class="bi bi-exclamation-triangle"></i> MODALIT√Ä TEST ATTIVA</strong><br>
      La validazione dei campi obbligatori √® disabilitata per i test.
      <button type="button" class="btn btn-primary btn-sm mt-2" id="fillTestDataBtn">
        <i class="bi bi-magic"></i> Compila dati di test
      </button>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
    `;
    
    // Inserisci il banner dopo il titolo
    const titleElement = document.querySelector('h2');
    if (titleElement) {
      titleElement.insertAdjacentElement('afterend', testBanner);
    }
    
    // Aggiungi event listener per il pulsante di auto-compilazione
    setTimeout(() => {
      const fillTestDataBtn = document.getElementById('fillTestDataBtn');
      if (fillTestDataBtn) {
        fillTestDataBtn.addEventListener('click', fillTestData);
      }
    }, 100);
  }
});

// Funzione per compilare automaticamente i campi con dati di test
function fillTestData() {
  console.log('üîß Compilazione automatica dati di test...');
  
  // Dati di test
  const testData = {
    // Step 1: Dati anagrafici
    'first_name': 'Mario',
    'last_name': 'Rossi',
    'gender': 'M',
    'date_of_birth': '1990-05-15',
    'place_of_birth': 'Roma',
    'nationality': 'Italiana',
    'marital_status': 'Celibe/Nubile',
    'come_sei_arrivato': 'Passaparola',
    'height_cm': '175',
    'weight_kg': '70',
    'tshirt_size': 'M',
    'shoe_size_eu': '42',
    'phone_number': '+39 333 1234567',
    'email': 'mario.rossi@test.com',
    
    // Step 2: Documenti e patente
    'address': 'Via Roma 123',
    'city': 'Milano',
    'postal_code': '20100',
    'country_of_residence': 'Italia',
    'id_document': 'Carta identit√†',
    'id_number': 'CA1234567',
    'id_expiry_date': '2030-12-31',
    'id_country': 'Italia',
    'additional_document': 'Tessera sanitaria',
    'codice_fiscale': 'RSSMRA90E15H501Z',
    'permesso_soggiorno': 'PS123456789',
    'license_country': 'Italia',
    'license_number': 'MI1234567',
    'license_category': 'B',
    'license_issue_date': '2010-06-01',
    'license_expiry_date': '2040-06-01',
    'years_driving_experience': '14',
    'auto_moto_munito': '1',
    
    // Step 3: Esperienze e lingue
    'occupation': 'Sviluppatore Software',
    'other_experience': 'Esperienza di 5 anni nel settore IT, specializzato in applicazioni web e mobile. Competenze in JavaScript, Python, React.',
    'availability_from': '2025-08-01',
    'availability_till': '2025-12-31',
    'other_location': 'Milano, Roma, disponibile per trasferte',
    'language_1': 'Italiano',
    'proficiency_1': 'Madrelingua',
    'language_2': 'Inglese',
    'proficiency_2': 'Avanzato',
    'language_3': 'Francese',
    'proficiency_3': 'Base',
    'gdpr_consent': true
  };
  
  // Compila i campi (esclusi curriculum e foto)
  Object.entries(testData).forEach(([fieldId, value]) => {
    if (!value) return; // Salta campi vuoti
    
    const field = document.getElementById(fieldId);
    if (field) {
      if (field.tagName === 'SELECT') {
        // Per i campi select, trova l'opzione corrispondente
        const options = field.querySelectorAll('option');
        for (let option of options) {
          if (option.value === value || option.textContent.trim() === value) {
            field.value = option.value;
            break;
          }
        }
      } else if (field.type === 'checkbox') {
        // Per i checkbox, imposta checked
        field.checked = Boolean(value);
      } else {
        field.value = value;
      }
      
      // Trigger evento per aggiornare la validazione
      field.dispatchEvent(new Event('input', { bubbles: true }));
      field.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });
  
  console.log('‚úÖ Dati di test compilati automaticamente!');
  console.log('üìÑ Ricorda di caricare manualmente il curriculum e la foto');
  
  // Mostra un messaggio di conferma
  const successMessage = document.createElement('div');
  successMessage.className = 'alert alert-success alert-dismissible fade show mt-2';
  successMessage.innerHTML = `
    <strong><i class="bi bi-check-circle"></i> Dati di test compilati!</strong><br>
    <small>Ricorda di caricare manualmente il curriculum e la foto profilo.</small>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
  `;
  
  // Inserisci dopo il banner di test
  const testBanner = document.querySelector('.alert-warning');
  if (testBanner) {
    testBanner.insertAdjacentElement('afterend', successMessage);
    
    // Rimuovi il messaggio dopo 5 secondi
    setTimeout(() => {
      if (successMessage.parentNode) {
        successMessage.remove();
      }
    }, 5000);
  }
}
</script>
{% endblock %}
