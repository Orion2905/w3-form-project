{% extends 'layout_sidebar.html' %}
{% block content %}
<h2 class="mb-4">Dashboard</h2>

<!-- Sezione Filtri -->
<div class="card mb-4" style="background-color: #e3f2fd; border: 3px solid #1976d2;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0" style="color: #1976d2; font-weight: bold;">üîç FILTRI DASHBOARD</h5>
      <span id="filter-status" class="badge bg-primary" style="display: block; font-size: 14px;">Filtri attivi</span>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <label for="filter-evento" class="form-label" style="font-weight: bold; color: #1976d2;">Evento</label>
        <select class="form-select" id="filter-evento" style="border: 2px solid #4caf50; font-size: 16px;">
          <option value="">Tutti gli eventi</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="filter-azienda" class="form-label" style="font-weight: bold; color: #1976d2;">Azienda</label>
        <select class="form-select" id="filter-azienda" style="border: 2px solid #4caf50; font-size: 16px;">
          <option value="">Tutte le aziende</option>
        </select>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12">
        <button type="button" class="btn btn-primary btn-lg" onclick="applyFilters()" style="font-size: 18px;">
          <i class="fas fa-filter me-2"></i>Applica Filtri
        </button>
        <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="clearFilters()" style="font-size: 18px;">
          <i class="fas fa-times me-2"></i>Rimuovi Filtri
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-12 col-md-4">
    <div class="card text-center p-3">
      <div class="fs-2 fw-bold" id="stat-total">-</div>
      <div class="text-muted">Candidati totali</div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="card text-center p-3">
      <div class="fs-2 fw-bold" id="stat-cv">-</div>
      <div class="text-muted">Con Curriculum</div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="card text-center p-3">
      <div class="fs-2 fw-bold" id="stat-photo">-</div>
      <div class="text-muted">Con Foto</div>
    </div>
  </div>
</div>
<div class="row g-4 mb-4">
  <div class="col-12 col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3">Distribuzione per genere</h5>
      <canvas id="chart-gender" height="180"></canvas>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3">Stato civile</h5>
      <canvas id="chart-marital" height="180"></canvas>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3">Taglia T-shirt</h5>
      <canvas id="chart-tshirt" height="180"></canvas>
    </div>
  </div>
</div>
<div class="row g-4 mb-4">
  <div class="col-6 col-lg-3">
    <div class="card p-3">
      <h5 class="mb-3">Occupazione</h5>
      <canvas id="chart-roles" height="120" style="max-width:180px;"></canvas>
    </div>
  </div>
  <div class="col-6 col-lg-3 order-lg-1">
    <div class="card p-3">
      <h5 class="mb-3">Auto/Moto</h5>
      <canvas id="chart-auto" height="120" style="max-width:180px;"></canvas>
    </div>
  </div>
  <div class="col-12 col-lg-6 order-lg-2">
    <div class="card p-3 h-100 d-flex flex-column justify-content-between">
      <h5 class="mb-3">Ultimi candidati inseriti</h5>
      <div class="table-responsive position-relative">
        <div id="latest-loader" class="position-absolute top-50 start-50 translate-middle" style="display:none;z-index:2">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
        <table class="table table-sm align-middle mb-0 w-100 animate__animated animate__fadeIn" id="latest-table">
          <thead>
            <tr>
              <th style="min-width:120px">Nome</th>
              <th style="min-width:180px">Email</th>
              <th style="min-width:100px">Ruolo</th>
              <th style="min-width:100px">Citt√†</th>
              <th style="min-width:100px">Genere</th>
              <th style="min-width:100px">Data</th>
            </tr>
          </thead>
          <tbody id="latest-candidates">
            <tr><td colspan="6" class="text-center text-muted">Caricamento...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="row g-4 mb-4">
  <div class="col-12 col-lg-6">
    <div class="card p-3">
      <h5 class="mb-3">Candidati per mese</h5>
      <canvas id="chart-monthly" height="180"></canvas>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card p-3">
      <h5 class="mb-3">Top 10 Citt√†</h5>
      <canvas id="chart-cities" height="180"></canvas>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Variabili globali per i grafici
window.charts = {};

// Funzioni per gestire i filtri
async function loadFilters() {
  try {
    // Carica eventi
    const eventi = await fetch('/api/stats/eventi').then(r => r.json());
    const eventoSelect = document.getElementById('filter-evento');
    eventi.forEach(evento => {
      const option = document.createElement('option');
      option.value = evento;
      option.textContent = evento;
      eventoSelect.appendChild(option);
    });

    // Carica aziende
    const aziende = await fetch('/api/stats/aziende').then(r => r.json());
    const aziendaSelect = document.getElementById('filter-azienda');
    aziende.forEach(azienda => {
      const option = document.createElement('option');
      option.value = azienda;
      option.textContent = azienda;
      aziendaSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Errore nel caricamento dei filtri:', error);
  }
}

// Applica i filtri
function applyFilters() {
  updateFilterStatus();
  fetchStats();
}

// Rimuove tutti i filtri
function clearFilters() {
  document.getElementById('filter-evento').value = '';
  document.getElementById('filter-azienda').value = '';
  updateFilterStatus();
  fetchStats();
}

// Aggiorna lo stato dei filtri
function updateFilterStatus() {
  const evento = document.getElementById('filter-evento').value;
  const azienda = document.getElementById('filter-azienda').value;
  const statusBadge = document.getElementById('filter-status');
  
  if (evento || azienda) {
    statusBadge.style.display = 'inline-block';
    statusBadge.className = 'badge bg-primary';
    statusBadge.textContent = 'Filtri attivi';
  } else {
    statusBadge.style.display = 'none';
  }
}

async function fetchStats() {
  // Loader visibile
  document.getElementById('latest-loader').style.display = '';
  document.getElementById('latest-table').classList.remove('animate__fadeIn');

  // Distruggi i grafici esistenti
  if (typeof charts !== 'undefined') {
    Object.values(charts).forEach(chart => {
      if (chart && typeof chart.destroy === 'function') chart.destroy();
    });
  }
  window.charts = {};

  // Ottieni parametri filtro
  const evento = document.getElementById('filter-evento') ? document.getElementById('filter-evento').value : '';
  const azienda = document.getElementById('filter-azienda') ? document.getElementById('filter-azienda').value : '';
  
  const params = new URLSearchParams();
  if (evento) params.append('evento', evento);
  if (azienda) params.append('azienda', azienda);
  const queryString = params.toString() ? `?${params.toString()}` : '';

  const summary = await fetch(`/api/stats/summary${queryString}`).then(r=>r.json());
  document.getElementById('stat-total').textContent = summary.total;
  document.getElementById('stat-cv').textContent = summary.with_cv;
  document.getElementById('stat-photo').textContent = summary.with_photo;

  const roles = await fetch(`/api/stats/roles${queryString}`).then(r=>r.json());
  const ctxRoles = document.getElementById('chart-roles').getContext('2d');
  window.charts.roles = new Chart(ctxRoles, {
    type: 'doughnut',
    data: {
      labels: Object.keys(roles),
      datasets: [{
        data: Object.values(roles),
        backgroundColor: ['#7db7e8','#bfaee0','#ffd6a5','#b6e2d3','#ffb3b3'],
      }]
    },
    options: {responsive:true, cutout:'70%', plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}}}
  });

  const gender = await fetch(`/api/stats/gender${queryString}`).then(r=>r.json());
  const ctxGender = document.getElementById('chart-gender').getContext('2d');
  window.charts.gender = new Chart(ctxGender, {
    type: 'pie',
    data: {
      labels: Object.keys(gender),
      datasets: [{
        data: Object.values(gender),
        backgroundColor: ['#7db7e8','#bfaee0','#ffd6a5','#b6e2d3','#ffb3b3'],
      }]
    },
    options: {responsive:true, plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}}}
  });

  const marital = await fetch(`/api/stats/marital_status${queryString}`).then(r=>r.json());
  const ctxMarital = document.getElementById('chart-marital').getContext('2d');
  window.charts.marital = new Chart(ctxMarital, {
    type: 'pie',
    data: {
      labels: Object.keys(marital),
      datasets: [{
        data: Object.values(marital),
        backgroundColor: ['#ffd6a5','#bfaee0','#b6e2d3','#7db7e8','#ffb3b3'],
      }]
    },
    options: {responsive:true, plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}}}
  });

  const tshirt = await fetch(`/api/stats/tshirt_size${queryString}`).then(r=>r.json());
  const ctxTshirt = document.getElementById('chart-tshirt').getContext('2d');
  window.charts.tshirt = new Chart(ctxTshirt, {
    type: 'doughnut',
    data: {
      labels: Object.keys(tshirt),
      datasets: [{
        data: Object.values(tshirt),
        backgroundColor: ['#bfaee0','#ffd6a5','#b6e2d3','#7db7e8','#ffb3b3'],
      }]
    },
    options: {responsive:true, plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}}}
  });

  const auto = await fetch(`/api/stats/auto_moto_munito${queryString}`).then(r=>r.json());
  const ctxAuto = document.getElementById('chart-auto').getContext('2d');
  window.charts.auto = new Chart(ctxAuto, {
    type: 'doughnut',
    data: {
      labels: Object.keys(auto),
      datasets: [{
        data: Object.values(auto),
        backgroundColor: ['#b6e2d3','#ffb3b3','#bfaee0'],
      }]
    },
    options: {responsive:true, cutout:'75%', plugins:{legend:{display:false}}}
  });

  const monthly = await fetch(`/api/stats/monthly${queryString}`).then(r=>r.json());
  const ctxMonthly = document.getElementById('chart-monthly').getContext('2d');
  window.charts.monthly = new Chart(ctxMonthly, {
    type: 'bar',
    data: {
      labels: Object.keys(monthly),
      datasets: [{
        label: 'Candidati',
        data: Object.values(monthly),
        backgroundColor: '#7db7e8',
      }]
    },
    options: {responsive:true, plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}},
      scales:{x:{ticks:{color:getComputedStyle(document.body).color}},y:{ticks:{color:getComputedStyle(document.body).color}}}}
  });

  const cities = await fetch(`/api/stats/cities${queryString}`).then(r=>r.json());
  const ctxCities = document.getElementById('chart-cities').getContext('2d');
  window.charts.cities = new Chart(ctxCities, {
    type: 'bar',
    data: {
      labels: Object.keys(cities),
      datasets: [{
        label: 'Candidati',
        data: Object.values(cities),
        backgroundColor: ['#7db7e8','#bfaee0','#ffd6a5','#b6e2d3','#ffb3b3','#d4a5a5','#a5d4d4','#d4d4a5','#a5a5d4','#d4a5d4'],
      }]
    },
    options: {
      responsive:true, 
      indexAxis: 'y',
      plugins:{legend:{labels:{color:getComputedStyle(document.body).color}}},
      scales:{x:{ticks:{color:getComputedStyle(document.body).color}},y:{ticks:{color:getComputedStyle(document.body).color}}}
    }
  });

  const latest = await fetch(`/api/stats/latest${queryString}`).then(r=>r.json());
  const tbody = document.getElementById('latest-candidates');
  tbody.innerHTML = latest.map(c => `
    <tr class="animate__animated animate__fadeInUp">
      <td class="text-nowrap fw-semibold">${c.first_name} ${c.last_name}</td>
      <td class="text-break small">${c.email}</td>
      <td><span class="badge bg-primary">${c.role||'-'}</span></td>
      <td class="text-nowrap">${c.city||'-'}</td>
      <td class="text-nowrap">${c.gender||'-'}</td>
      <td class="text-nowrap">${c.created_at}</td>
    </tr>
  `).join('');
  // Loader nascosto e animazione
  document.getElementById('latest-loader').style.display = 'none';
  document.getElementById('latest-table').classList.add('animate__fadeIn');
}
// Carica filtri e dati all'avvio
document.addEventListener('DOMContentLoaded', function() {
  loadFilters();
  fetchStats();
});
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
