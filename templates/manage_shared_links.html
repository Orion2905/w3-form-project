{% extends "layout_sidebar.html" %}

{% block content %}
<style>
#bulkActionBar {
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

#bulkActionBar .card-body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.share-link-card {
    transition: all 0.2s ease;
}

.share-link-card:has(input[type="checkbox"]:checked) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #0d6efd;
}

.form-check-input:checked + .form-check-label,
.form-check-input:checked ~ h6 {
    color: #0d6efd;
    font-weight: 500;
}

.bulk-action-btn {
    position: relative;
    overflow: hidden;
}

.bulk-action-btn:hover {
    transform: translateY(-1px);
}

#selectAll:indeterminate {
    background-color: #6c757d;
    border-color: #6c757d;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10h8'/%3e%3c/svg%3e");
}

/* Stili per il modal di protezione */
.protection-option {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.protection-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.protection-option.selected {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.protection-option input[type="radio"]:checked + label .card-title {
    color: #0d6efd;
}

#passwordMatch.text-success {
    color: #198754 !important;
}

#passwordMatch.text-danger {
    color: #dc3545 !important;
}
</style>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-share me-2"></i>
                Gestione Link Condivisi
            </h2>
            <div>
                <button class="btn btn-outline-warning me-2" onclick="cleanupExpiredLinks()">
                    <i class="bi bi-trash me-2"></i>
                    Pulisci Scaduti
                </button>
                <a href="{{ url_for('main.candidates_list') }}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crea Nuovo Link
                </a>
            </div>
        </div>

        <!-- Statistiche generali -->
        {% if share_links %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ share_links|length }}</h3>
                        <p class="text-muted mb-0">Link Totali</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">
                            {% set active_count = 0 %}
                            {% for link in share_links %}
                                {% if not link.expires_at or not link.is_expired() %}
                                    {% set active_count = active_count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ active_count }}
                        </h3>
                        <p class="text-muted mb-0">Link Attivi</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">
                            {% set expired_count = 0 %}
                            {% for link in share_links %}
                                {% if link.expires_at and link.is_expired() %}
                                    {% set expired_count = expired_count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ expired_count }}
                        </h3>
                        <p class="text-muted mb-0">Link Scaduti</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-info">{{ share_links|sum(attribute='accessed_count') }}</h3>
                        <p class="text-muted mb-0">Visualizzazioni Totali</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtri e ricerca -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Stato</label>
                        <select class="form-select" id="filterStatus" onchange="filterLinks()">
                            <option value="all">Tutti</option>
                            <option value="active">Solo Attivi</option>
                            <option value="expired">Solo Scaduti</option>
                            <option value="protected">Solo Protetti</option>
                            <option value="public">Solo Pubblici</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sortBy" class="form-label">Ordina per</label>
                        <select class="form-select" id="sortBy" onchange="sortLinks()">
                            <option value="created_desc">Più recenti</option>
                            <option value="created_asc">Più vecchi</option>
                            <option value="accessed_desc">Più visualizzati</option>
                            <option value="accessed_asc">Meno visualizzati</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Cerca</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Cerca nei link..." onkeyup="searchLinks()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Selezione</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label class="form-check-label" for="selectAll">
                                Seleziona tutto
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra azioni bulk (nascosta inizialmente) -->
        <div id="bulkActionBar" class="card mb-4" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="selectedCount">0</span> elementi selezionati
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning bulk-action-btn" id="extendExpiryBtn">
                            <i class="bi bi-clock-history me-1"></i>
                            Estendi Scadenza
                        </button>
                        <button type="button" class="btn btn-outline-info bulk-action-btn" onclick="bulkToggleProtection()">
                            <i class="bi bi-shield me-1"></i>
                            Cambia Protezione
                        </button>
                        <button type="button" class="btn btn-outline-success bulk-action-btn" onclick="bulkExport()">
                            <i class="bi bi-download me-1"></i>
                            Esporta
                        </button>
                        <button type="button" class="btn btn-outline-danger bulk-action-btn" onclick="bulkDelete()">
                            <i class="bi bi-trash me-1"></i>
                            Elimina
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if share_links %}
            <div class="row">
                {% for link in share_links %}
                <div class="col-lg-6 col-xl-4 mb-4 share-link-card" 
                     data-created="{{ link.created_at.isoformat() }}" 
                     data-accessed="{{ link.accessed_count }}">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input me-3" type="checkbox" value="{{ link.id }}" 
                                       id="link_{{ link.id }}" onchange="updateBulkActionBar()" data-link-checkbox>
                                <h6 class="mb-0">
                                    <i class="bi bi-link-45deg me-1"></i>
                                    Link Condiviso #{{ link.id }}
                                </h6>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="/shared/{{ link.token }}" target="_blank">
                                            <i class="bi bi-eye me-2"></i>Visualizza
                                        </a>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" onclick="copyShareUrl('{{ request.url_root.rstrip('/') }}/shared/{{ link.token }}')">
                                            <i class="bi bi-clipboard me-2"></i>Copia Link
                                        </button>
                                    </li>
                                    {% if link.expires_at and link.is_expired() %}
                                    <li>
                                        <button class="dropdown-item text-warning" onclick="extendExpiry({{ link.id }})">
                                            <i class="bi bi-clock-history me-2"></i>Estendi Scadenza
                                        </button>
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="POST" action="{{ url_for('main.delete_shared_link', share_id=link.id) }}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Sei sicuro di voler eliminare questo link condiviso?')">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-trash me-2"></i>Elimina
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- Informazioni di base -->
                            <div class="mb-3">
                                <p class="mb-2">
                                    <i class="bi bi-calendar me-2 text-muted"></i>
                                    <strong>Creato:</strong> {{ link.created_at.strftime('%d/%m/%Y alle %H:%M') }}
                                </p>
                                
                                {% if link.expires_at %}
                                <p class="mb-2">
                                    <i class="bi bi-clock me-2 text-muted"></i>
                                    <strong>Scade:</strong> 
                                    <span class="{% if link.is_expired() %}text-danger{% else %}text-success{% endif %}">
                                        {{ link.expires_at.strftime('%d/%m/%Y alle %H:%M') }}
                                        {% if link.is_expired() %}
                                            <span class="badge bg-danger ms-1">Scaduto</span>
                                        {% endif %}
                                    </span>
                                </p>
                                {% else %}
                                <p class="mb-2">
                                    <i class="bi bi-infinity me-2 text-muted"></i>
                                    <strong>Scadenza:</strong> Nessuna
                                </p>
                                {% endif %}
                                
                                <p class="mb-2">
                                    <i class="bi bi-shield me-2 text-muted"></i>
                                    <strong>Protezione:</strong> 
                                    {% if link.password_hash %}
                                        <span class="badge bg-warning">Password protetto</span>
                                    {% else %}
                                        <span class="badge bg-info">Pubblico</span>
                                    {% endif %}
                                </p>
                            </div>
                            
                            <!-- Statistiche -->
                            <div class="mb-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h5 class="mb-1 text-primary">{{ link.fields|length }}</h5>
                                            <small class="text-muted">Campi</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="mb-1 text-success">{{ link.accessed_count }}</h5>
                                        <small class="text-muted">Visualizzazioni</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configurazione -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Configurazione:</h6>
                                <ul class="list-unstyled small">
                                    <li>
                                        <i class="bi bi-collection me-1"></i>
                                        <strong>Scope:</strong> 
                                        {% if link.scope == 'all' %}
                                            Tutti i candidati
                                        {% else %}
                                            Solo candidati filtrati
                                        {% endif %}
                                    </li>
                                    <li>
                                        <i class="bi bi-archive me-1"></i>
                                        <strong>Archivio:</strong> 
                                        {% if link.archived %}
                                            Candidati archiviati
                                        {% else %}
                                            Candidati attivi
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                            
                            {% if link.last_accessed_at %}
                            <div class="text-muted small">
                                <i class="bi bi-clock-history me-1"></i>
                                Ultimo accesso: {{ link.last_accessed_at.strftime('%d/%m/%Y alle %H:%M') }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Token: {{ link.token[:8] }}...</small>
                                <div>
                                    <a href="/shared/{{ link.token }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" 
                                            onclick="copyShareUrl('{{ request.url_root.rstrip('/') }}/shared/{{ link.token }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Stato vuoto -->
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-share" style="font-size: 4rem; color: #dee2e6;"></i>
                </div>
                <h4 class="text-muted mb-3">Nessun link condiviso</h4>
                <p class="text-muted mb-4">
                    Non hai ancora creato alcun link di condivisione per le liste candidati.<br>
                    Vai alla lista candidati e usa il pulsante "Condividi" per creare il tuo primo link.
                </p>
                <a href="{{ url_for('main.candidates_list') }}" class="btn btn-primary">
                    <i class="bi bi-people me-2"></i>
                    Vai alla Lista Candidati
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Toast per feedback -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <strong class="me-auto">Successo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Link copiato negli appunti!
        </div>
    </div>
</div>

<!-- Modal per cambiare protezione -->
<div class="modal fade" id="changeProtectionModal" tabindex="-1" aria-labelledby="changeProtectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeProtectionModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>
                    Cambia Protezione Link Condivisi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong id="selectedLinksCount">0</strong> link selezionati per la modifica della protezione
                </div>

                <!-- Opzioni di protezione -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100 protection-option" data-action="remove">
                            <div class="card-body text-center">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="protectionAction" id="removeProtection" value="remove">
                                    <label class="form-check-label" for="removeProtection">
                                        <h5 class="card-title">
                                            <i class="bi bi-unlock text-success me-2"></i>
                                            Rimuovi Protezione
                                        </h5>
                                    </label>
                                </div>
                                <p class="card-text text-muted">
                                    I link selezionati diventeranno pubblici e non richiederanno più una password per l'accesso.
                                </p>
                                <div class="text-success">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Accesso libero per tutti
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100 protection-option" data-action="add">
                            <div class="card-body text-center">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="protectionAction" id="addProtection" value="add">
                                    <label class="form-check-label" for="addProtection">
                                        <h5 class="card-title">
                                            <i class="bi bi-lock text-warning me-2"></i>
                                            Aggiungi Protezione
                                        </h5>
                                    </label>
                                </div>
                                <p class="card-text text-muted">
                                    I link selezionati richiederanno una password per l'accesso.
                                </p>
                                <div class="text-warning">
                                    <i class="bi bi-shield-check me-1"></i>
                                    Solo utenti autorizzati
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campo password (visibile solo quando si aggiunge protezione) -->
                <div id="passwordSection" class="mt-4" style="display: none;">
                    <div class="card border-warning">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="bi bi-key me-2"></i>
                                Imposta Password
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="newPassword" class="form-label">Password *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" 
                                               placeholder="Inserisci la password..." required>
                                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        La password deve essere di almeno 4 caratteri
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmPassword" class="form-label">Conferma Password *</label>
                                    <input type="password" class="form-control" id="confirmPassword" 
                                           placeholder="Conferma la password..." required>
                                    <div id="passwordMatch" class="form-text"></div>
                                </div>
                            </div>
                            
                            <div class="mt-3 p-3 bg-light rounded">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    Suggerimenti per la sicurezza:
                                </h6>
                                <ul class="text-muted small mb-0">
                                    <li>Usa una password facile da ricordare ma difficile da indovinare</li>
                                    <li>Evita password troppo comuni come "password123"</li>
                                    <li>Condividi la password solo con persone autorizzate</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anteprima azioni -->
                <div class="mt-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="bi bi-eye me-2"></i>
                                Anteprima Modifiche
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="actionPreview" class="text-muted">
                                Seleziona un'azione per vedere l'anteprima delle modifiche
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annulla
                </button>
                <button type="button" class="btn btn-primary" id="confirmProtectionChange" disabled>
                    <i class="bi bi-shield-check me-2"></i>
                    Applica Modifiche
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal per estendere scadenza -->
<div class="modal fade" id="extendExpiryModal" tabindex="-1" aria-labelledby="extendExpiryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extendExpiryModalLabel">
                    <i class="bi bi-clock-history me-2"></i>
                    Estendi Scadenza Link Condivisi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong id="selectedLinksCountExpiry">0</strong> link selezionati per l'estensione della scadenza
                </div>

                <!-- Opzioni di estensione -->
                <div class="mb-4">
                    <h6 class="mb-3">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Scegli il periodo di estensione
                    </h6>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card h-100 expiry-option" data-days="7">
                                <div class="card-body text-center">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="expiryExtension" id="extend7days" value="7">
                                        <label class="form-check-label" for="extend7days">
                                            <h5 class="card-title text-primary">
                                                <i class="bi bi-calendar-week me-2"></i>
                                                7 Giorni
                                            </h5>
                                        </label>
                                    </div>
                                    <p class="card-text text-muted">
                                        Estensione rapida per progetti a breve termine
                                    </p>
                                    <div class="text-primary">
                                        <i class="bi bi-clock me-1"></i>
                                        +1 settimana
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 expiry-option" data-days="30">
                                <div class="card-body text-center">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="expiryExtension" id="extend30days" value="30">
                                        <label class="form-check-label" for="extend30days">
                                            <h5 class="card-title text-success">
                                                <i class="bi bi-calendar-month me-2"></i>
                                                30 Giorni
                                            </h5>
                                        </label>
                                    </div>
                                    <p class="card-text text-muted">
                                        Estensione standard per la maggior parte dei progetti
                                    </p>
                                    <div class="text-success">
                                        <i class="bi bi-calendar-check me-1"></i>
                                        +1 mese
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 expiry-option" data-days="90">
                                <div class="card-body text-center">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="expiryExtension" id="extend90days" value="90">
                                        <label class="form-check-label" for="extend90days">
                                            <h5 class="card-title text-warning">
                                                <i class="bi bi-calendar-range me-2"></i>
                                                90 Giorni
                                            </h5>
                                        </label>
                                    </div>
                                    <p class="card-text text-muted">
                                        Estensione estesa per progetti a lungo termine
                                    </p>
                                    <div class="text-warning">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        +3 mesi
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opzione personalizzata -->
                <div class="mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info bg-opacity-10">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="expiryExtension" id="customExtend" value="custom">
                                <label class="form-check-label" for="customExtend">
                                    <h6 class="mb-0">
                                        <i class="bi bi-sliders me-2"></i>
                                        Estensione Personalizzata
                                    </h6>
                                </label>
                            </div>
                        </div>
                        <div class="card-body" id="customExpirySection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="customDays" class="form-label">Numero di giorni</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="customDays" 
                                               placeholder="Inserisci giorni..." min="1" max="365">
                                        <span class="input-group-text">giorni</span>
                                    </div>
                                    <div class="form-text">
                                        Inserisci un valore tra 1 e 365 giorni
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Data di scadenza</label>
                                    <div class="form-control-plaintext" id="calculatedExpiry">
                                        Seleziona il numero di giorni
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informazioni sui link -->
                <div class="mb-4">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="bi bi-info-square me-2"></i>
                                Informazioni sui Link Selezionati
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="h5 mb-1 text-primary" id="activeLinksCount">0</div>
                                    <div class="small text-muted">Link Attivi</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="h5 mb-1 text-warning" id="expiredLinksCount">0</div>
                                    <div class="small text-muted">Link Scaduti</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="h5 mb-1 text-info" id="noExpiryLinksCount">0</div>
                                    <div class="small text-muted">Senza Scadenza</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anteprima azioni -->
                <div class="mt-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary bg-opacity-10">
                            <h6 class="mb-0">
                                <i class="bi bi-eye me-2"></i>
                                Anteprima Modifiche
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="expiryActionPreview" class="text-muted">
                                Seleziona un periodo di estensione per vedere l'anteprima delle modifiche
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annulla
                </button>
                <button type="button" class="btn btn-primary" id="confirmExpiryExtension" disabled>
                    <i class="bi bi-calendar-plus me-2"></i>
                    Estendi Scadenza
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyShareUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
        // Mostra il toast
        const toast = new bootstrap.Toast(document.getElementById('copyToast'));
        toast.show();
    }).catch(function(err) {
        console.error('Errore nel copiare il link: ', err);
        alert('Errore nel copiare il link');
    });
}

// Funzioni per filtri e ricerca
function filterLinks() {
    const filter = document.getElementById('filterStatus').value;
    const cards = document.querySelectorAll('.share-link-card');
    
    cards.forEach(card => {
        let show = true;
        
        switch(filter) {
            case 'active':
                show = !card.querySelector('.badge-danger');
                break;
            case 'expired':
                show = !!card.querySelector('.badge-danger');
                break;
            case 'protected':
                show = !!card.querySelector('.badge-warning');
                break;
            case 'public':
                show = !!card.querySelector('.badge-info') && !card.querySelector('.badge-warning');
                break;
            case 'all':
            default:
                show = true;
                break;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
}

function sortLinks() {
    const sortBy = document.getElementById('sortBy').value;
    const container = document.querySelector('.row:has(.share-link-card)');
    const cards = Array.from(document.querySelectorAll('.share-link-card'));
    
    if (cards.length === 0) return;
    
    cards.sort((a, b) => {
        switch(sortBy) {
            case 'created_desc':
                return new Date(b.dataset.created) - new Date(a.dataset.created);
            case 'created_asc':
                return new Date(a.dataset.created) - new Date(b.dataset.created);
            case 'accessed_desc':
                return parseInt(b.dataset.accessed) - parseInt(a.dataset.accessed);
            case 'accessed_asc':
                return parseInt(a.dataset.accessed) - parseInt(b.dataset.accessed);
            default:
                return 0;
        }
    });
    
    cards.forEach(card => container.appendChild(card));
}

function searchLinks() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.querySelectorAll('.share-link-card');
    
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

// Pulizia link scaduti
function cleanupExpiredLinks() {
    if (!confirm('Sei sicuro di voler eliminare tutti i link scaduti? Questa azione non può essere annullata.')) {
        return;
    }
    
    fetch('/api/candidates/shares/cleanup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nella pulizia dei link');
    });
}

// Estensione scadenza
function extendExpiry(shareId) {
    const days = prompt('Per quanti giorni vuoi estendere la scadenza?', '7');
    if (!days || isNaN(days) || days <= 0) {
        return;
    }
    
    fetch(`/api/candidates/shares/${shareId}/extend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ days: parseInt(days) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nell\'estensione della scadenza');
    });
}

// Funzioni per gestione selezione multipla
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const linkCheckboxes = document.querySelectorAll('[data-link-checkbox]');
    
    linkCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkActionBar();
}

function updateBulkActionBar() {
    const selectedCheckboxes = document.querySelectorAll('[data-link-checkbox]:checked');
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('[data-link-checkbox]');
    
    // Aggiorna il contatore
    selectedCount.textContent = selectedCheckboxes.length;
    
    // Mostra/nascondi la barra delle azioni bulk
    if (selectedCheckboxes.length > 0) {
        bulkActionBar.style.display = 'block';
    } else {
        bulkActionBar.style.display = 'none';
    }
    
    // Aggiorna lo stato del checkbox "Seleziona tutto"
    if (selectedCheckboxes.length === allCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function showAlert(message, type = 'info') {
    // Rimuovi eventuali alert esistenti
    const existingAlerts = document.querySelectorAll('.alert-floating');
    existingAlerts.forEach(alert => alert.remove());
    
    // Crea il nuovo alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Aggiungi al body
    document.body.appendChild(alertDiv);
    
    // Rimuovi automaticamente dopo 5 secondi
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function getSelectedLinkIds() {
    const selectedCheckboxes = document.querySelectorAll('[data-link-checkbox]:checked');
    return Array.from(selectedCheckboxes).map(cb => cb.value);
}

// Azioni bulk
function bulkDelete() {
    const selectedIds = getSelectedLinkIds();
    if (selectedIds.length === 0) {
        alert('Seleziona almeno un link da eliminare');
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare ${selectedIds.length} link selezionati? Questa azione non può essere annullata.`)) {
        return;
    }
    
    fetch('/api/candidates/shares/bulk-delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ link_ids: selectedIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nell\'eliminazione dei link');
    });
}

function bulkExtendExpiry() {
    const selectedIds = getSelectedLinkIds();
    if (selectedIds.length === 0) {
        alert('Seleziona almeno un link per estendere la scadenza');
        return;
    }
    
    const days = prompt('Per quanti giorni vuoi estendere la scadenza dei link selezionati?', '7');
    if (!days || isNaN(days) || days <= 0) {
        return;
    }
    
    fetch('/api/candidates/shares/bulk-extend', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ link_ids: selectedIds, days: parseInt(days) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nell\'estensione della scadenza');
    });
}

function bulkToggleProtection() {
    const selectedIds = getSelectedLinkIds();
    if (selectedIds.length === 0) {
        alert('Seleziona almeno un link per modificare la protezione');
        return;
    }
    
    // Aggiorna il conteggio nel modal
    document.getElementById('selectedLinksCount').textContent = selectedIds.length;
    
    // Reset del modal
    document.querySelectorAll('input[name="protectionAction"]').forEach(radio => radio.checked = false);
    document.getElementById('passwordSection').style.display = 'none';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('passwordMatch').textContent = '';
    document.getElementById('actionPreview').textContent = 'Seleziona un\'azione per vedere l\'anteprima delle modifiche';
    document.getElementById('confirmProtectionChange').disabled = true;
    document.querySelectorAll('.protection-option').forEach(card => card.classList.remove('selected'));
    
    // Mostra il modal
    const modal = new bootstrap.Modal(document.getElementById('changeProtectionModal'));
    modal.show();
}

function bulkExport() {
    const selectedIds = getSelectedLinkIds();
    if (selectedIds.length === 0) {
        alert('Seleziona almeno un link da esportare');
        return;
    }
    
    // Crea un CSV con le informazioni dei link selezionati
    const csvData = [];
    csvData.push(['ID', 'Token', 'Titolo', 'Creato', 'Scadenza', 'Accessi', 'URL']);
    
    selectedIds.forEach(linkId => {
        const card = document.querySelector(`[data-link-checkbox][value="${linkId}"]`).closest('.share-link-card');
        const cardText = card.textContent;
        
        // Estrai le informazioni dalla card (semplificato)
        const token = cardText.match(/Token: (\w+)/)?.[1] || '';
        const created = card.querySelector('[data-created]')?.getAttribute('data-created') || '';
        const accessed = card.querySelector('[data-accessed]')?.getAttribute('data-accessed') || '0';
        const url = `${window.location.origin}/shared/${token}`;
        
        csvData.push([linkId, token, `Link #${linkId}`, created, '', accessed, url]);
    });
    
    // Crea e scarica il file CSV
    const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `shared_links_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Event listeners per il modal di protezione
document.addEventListener('DOMContentLoaded', function() {
    // Gestione pulsante estendi scadenza
    const extendExpiryBtn = document.getElementById('extendExpiryBtn');
    const extendExpiryModal = new bootstrap.Modal(document.getElementById('extendExpiryModal'));
    
    // Pulsante estendi scadenza
    if (extendExpiryBtn) {
        extendExpiryBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const selectedIds = getSelectedLinkIds();
            
            if (selectedIds.length === 0) {
                showAlert('Seleziona almeno un link per estendere la scadenza', 'warning');
                return;
            }
            
            // Aggiorna contatore nel modal
            updateExpiryModalInfo(selectedIds);
            
            // Mostra il modal
            extendExpiryModal.show();
        });
    }
    
    // Gestione selezione periodo di estensione
    const expiryOptions = document.querySelectorAll('.expiry-option');
    const expiryRadios = document.querySelectorAll('input[name="expiryExtension"]');
    const customExpirySection = document.getElementById('customExpirySection');
    const customDaysInput = document.getElementById('customDays');
    const calculatedExpiryDiv = document.getElementById('calculatedExpiry');
    const confirmExpiryBtn = document.getElementById('confirmExpiryExtension');
    const expiryActionPreview = document.getElementById('expiryActionPreview');
    
    // Click sulle card
    expiryOptions.forEach(option => {
        option.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            updateExpirySelection();
        });
    });
    
    // Change sui radio button
    expiryRadios.forEach(radio => {
        radio.addEventListener('change', updateExpirySelection);
    });
    
    // Input giorni personalizzati
    if (customDaysInput) {
        customDaysInput.addEventListener('input', function() {
            updateCalculatedExpiry();
            updateExpiryPreview();
            updateExpiryConfirmButton(); // Aggiungi questa chiamata
        });
    }
    
    function updateExpirySelection() {
        const selectedValue = document.querySelector('input[name="expiryExtension"]:checked')?.value;
        
        // Rimuovi selezione precedente
        expiryOptions.forEach(option => {
            option.classList.remove('selected');
        });
        
        // Aggiungi selezione alla card corrente
        if (selectedValue && selectedValue !== 'custom') {
            const selectedOption = document.querySelector(`.expiry-option[data-days="${selectedValue}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }
        
        // Mostra/nascondi sezione personalizzata
        if (customExpirySection) {
            customExpirySection.style.display = selectedValue === 'custom' ? 'block' : 'none';
        }
        
        // Aggiorna l'anteprima
        updateExpiryPreview();
        
        // Abilita/disabilita pulsante conferma
        updateExpiryConfirmButton();
    }
    
    function updateCalculatedExpiry() {
        const days = parseInt(customDaysInput.value);
        
        if (isNaN(days) || days < 1) {
            calculatedExpiryDiv.textContent = 'Inserisci un numero valido';
            calculatedExpiryDiv.className = 'form-control-plaintext text-muted';
            return;
        }
        
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + days);
        
        calculatedExpiryDiv.textContent = futureDate.toLocaleDateString('it-IT');
        calculatedExpiryDiv.className = 'form-control-plaintext text-success fw-bold';
    }
    
    function updateExpiryPreview() {
        const selectedValue = document.querySelector('input[name="expiryExtension"]:checked')?.value;
        const selectedIds = getSelectedLinkIds();
        
        if (!selectedValue) {
            expiryActionPreview.innerHTML = '<em class="text-muted">Seleziona un periodo di estensione per vedere l\'anteprima delle modifiche</em>';
            return;
        }
        
        let days;
        let description;
        
        if (selectedValue === 'custom') {
            days = parseInt(customDaysInput.value);
            if (isNaN(days) || days < 1) {
                expiryActionPreview.innerHTML = '<em class="text-warning">Inserisci un numero di giorni valido</em>';
                return;
            }
            description = `${days} giorni`;
        } else {
            days = parseInt(selectedValue);
            switch (days) {
                case 7:
                    description = '1 settimana';
                    break;
                case 30:
                    description = '1 mese';
                    break;
                case 90:
                    description = '3 mesi';
                    break;
                default:
                    description = `${days} giorni`;
            }
        }
        
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + days);
        
        expiryActionPreview.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-plus text-primary me-3"></i>
                <div>
                    <strong>Estensione di ${description}</strong><br>
                    <small class="text-muted">
                        Nuova scadenza: <span class="text-success fw-bold">${futureDate.toLocaleDateString('it-IT')}</span><br>
                        Verranno aggiornati <strong>${selectedIds.length}</strong> link selezionati
                    </small>
                </div>
            </div>
        `;
    }
    
    function updateExpiryConfirmButton() {
        const selectedValue = document.querySelector('input[name="expiryExtension"]:checked')?.value;
        let isValid = false;
        
        if (selectedValue === 'custom') {
            const days = parseInt(customDaysInput.value);
            isValid = !isNaN(days) && days >= 1 && days <= 365;
        } else if (selectedValue) {
            isValid = true;
        }
        
        if (confirmExpiryBtn) {
            confirmExpiryBtn.disabled = !isValid;
        }
    }
    
    function updateExpiryModalInfo(selectedIds) {
        // Aggiorna contatore
        const selectedLinksCountExpiry = document.getElementById('selectedLinksCountExpiry');
        if (selectedLinksCountExpiry) {
            selectedLinksCountExpiry.textContent = selectedIds.length;
        }
        
        // Calcola statistiche sui link
        let activeCount = 0;
        let expiredCount = 0;
        let noExpiryCount = 0;
        
        selectedIds.forEach(id => {
            const checkbox = document.querySelector(`[data-link-checkbox][value="${id}"]`);
            if (checkbox) {
                const card = checkbox.closest('.share-link-card');
                if (card) {
                    const expiryText = card.textContent;
                    if (expiryText.includes('Mai') || expiryText.includes('Nessuna scadenza')) {
                        noExpiryCount++;
                    } else if (expiryText.includes('Scaduto')) {
                        expiredCount++;
                    } else {
                        activeCount++;
                    }
                }
            }
        });
        
        // Aggiorna contatori
        const activeLinksCount = document.getElementById('activeLinksCount');
        const expiredLinksCount = document.getElementById('expiredLinksCount');
        const noExpiryLinksCount = document.getElementById('noExpiryLinksCount');
        
        if (activeLinksCount) activeLinksCount.textContent = activeCount;
        if (expiredLinksCount) expiredLinksCount.textContent = expiredCount;
        if (noExpiryLinksCount) noExpiryLinksCount.textContent = noExpiryCount;
    }
    
    // Conferma estensione scadenza
    if (confirmExpiryBtn) {
        confirmExpiryBtn.addEventListener('click', function() {
            const selectedValue = document.querySelector('input[name="expiryExtension"]:checked')?.value;
            const selectedIds = getSelectedLinkIds();
            
            if (!selectedValue || selectedIds.length === 0) {
                return;
            }
            
            let days;
            if (selectedValue === 'custom') {
                days = parseInt(customDaysInput.value);
                if (isNaN(days) || days < 1 || days > 365) {
                    alert('Inserisci un numero di giorni valido (1-365)');
                    return;
                }
            } else {
                days = parseInt(selectedValue);
            }
            
            // Disabilita pulsante e mostra loading
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Estendendo...';
            
            // Chiamata API
            fetch('/api/candidates/shares/bulk-extend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ link_ids: selectedIds, days: days })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Chiudi modal e mostra toast di successo
                    extendExpiryModal.hide();
                    
                    // Crea toast di successo personalizzato
                    const toast = document.createElement('div');
                    toast.className = 'toast show';
                    toast.setAttribute('role', 'alert');
                    toast.innerHTML = `
                        <div class="toast-header">
                            <i class="bi bi-clock-history text-success me-2"></i>
                            <strong class="me-auto">Scadenza Estesa</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${data.message}
                        </div>
                    `;
                    
                    document.querySelector('.toast-container').appendChild(toast);
                    
                    // Ricarica la pagina dopo un momento
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    alert('Errore: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Estendi Scadenza';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore nell\'estensione della scadenza');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Estendi Scadenza';
            });
        });
    }
    
    // Reset del modal quando viene chiuso
    document.getElementById('extendExpiryModal').addEventListener('hidden.bs.modal', function() {
        // Reset selezioni
        document.querySelectorAll('input[name="expiryExtension"]').forEach(radio => {
            radio.checked = false;
        });
        
        if (customDaysInput) customDaysInput.value = '';
        if (customExpirySection) customExpirySection.style.display = 'none';
        if (calculatedExpiryDiv) {
            calculatedExpiryDiv.textContent = 'Seleziona il numero di giorni';
            calculatedExpiryDiv.className = 'form-control-plaintext';
        }
        
        expiryOptions.forEach(option => option.classList.remove('selected'));
        
        if (expiryActionPreview) {
            expiryActionPreview.innerHTML = '<em class="text-muted">Seleziona un periodo di estensione per vedere l\'anteprima delle modifiche</em>';
        }
        
        if (confirmExpiryBtn) {
            confirmExpiryBtn.disabled = true;
            confirmExpiryBtn.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Estendi Scadenza';
        }
    });

    // Gestione selezione delle opzioni di protezione
    document.querySelectorAll('.protection-option').forEach(card => {
        card.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Aggiorna aspetto visivo
            document.querySelectorAll('.protection-option').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            
            // Mostra/nasconde sezione password
            const passwordSection = document.getElementById('passwordSection');
            const actionPreview = document.getElementById('actionPreview');
            const selectedCount = document.getElementById('selectedLinksCount').textContent;
            
            if (radio.value === 'add') {
                passwordSection.style.display = 'block';
                actionPreview.innerHTML = `
                    <div class="text-warning">
                        <i class="bi bi-lock me-2"></i>
                        <strong>${selectedCount}</strong> link saranno protetti con password
                    </div>
                    <div class="small text-muted mt-1">
                        Gli utenti dovranno inserire la password per accedere ai link
                    </div>
                `;
            } else {
                passwordSection.style.display = 'none';
                actionPreview.innerHTML = `
                    <div class="text-success">
                        <i class="bi bi-unlock me-2"></i>
                        <strong>${selectedCount}</strong> link diventeranno pubblici
                    </div>
                    <div class="small text-muted mt-1">
                        Gli utenti potranno accedere ai link senza password
                    </div>
                `;
            }
            
            validateProtectionForm();
        });
    });
    
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordField = document.getElementById('newPassword');
        const icon = this.querySelector('i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordField.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });
    
    // Validazione password in tempo reale
    document.getElementById('newPassword').addEventListener('input', validatePasswords);
    document.getElementById('confirmPassword').addEventListener('input', validatePasswords);
    
    // Conferma modifiche
    document.getElementById('confirmProtectionChange').addEventListener('click', function() {
        const selectedAction = document.querySelector('input[name="protectionAction"]:checked');
        if (!selectedAction) return;
        
        const selectedIds = getSelectedLinkIds();
        let password = null;
        
        if (selectedAction.value === 'add') {
            password = document.getElementById('newPassword').value;
            if (!password || password.trim().length < 4) {
                alert('La password deve essere di almeno 4 caratteri');
                return;
            }
            
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (password !== confirmPassword) {
                alert('Le password non corrispondono');
                return;
            }
        }
        
        // Disabilita il pulsante e mostra loading
        this.disabled = true;
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Applicando...';
        
        // Chiamata API
        fetch('/api/candidates/shares/bulk-protection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                link_ids: selectedIds, 
                action: selectedAction.value,
                password: password 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Chiudi modal e mostra toast di successo
                bootstrap.Modal.getInstance(document.getElementById('changeProtectionModal')).hide();
                
                // Crea toast di successo personalizzato
                const toast = document.createElement('div');
                toast.className = 'toast show';
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="toast-header">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        <strong class="me-auto">Protezione Aggiornata</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${data.message}
                    </div>
                `;
                
                document.querySelector('.toast-container').appendChild(toast);
                
                // Ricarica la pagina dopo un momento
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('Errore: ' + data.error);
                this.disabled = false;
                this.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Errore nella modifica della protezione');
            this.disabled = false;
            this.innerHTML = originalText;
        });
    });
});

function validatePasswords() {
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('passwordMatch');
    
    if (!confirmPassword) {
        matchDiv.textContent = '';
        matchDiv.className = 'form-text';
    } else if (password === confirmPassword) {
        matchDiv.textContent = '✓ Le password corrispondono';
        matchDiv.className = 'form-text text-success';
    } else {
        matchDiv.textContent = '✗ Le password non corrispondono';
        matchDiv.className = 'form-text text-danger';
    }
    
    validateProtectionForm();
}

function validateProtectionForm() {
    const selectedAction = document.querySelector('input[name="protectionAction"]:checked');
    const confirmBtn = document.getElementById('confirmProtectionChange');
    
    if (!selectedAction) {
        confirmBtn.disabled = true;
        return;
    }
    
    if (selectedAction.value === 'add') {
        const password = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        confirmBtn.disabled = !password || password.length < 4 || password !== confirmPassword;
    } else {
        confirmBtn.disabled = false;
    }
}
</script>
{% endblock %}
