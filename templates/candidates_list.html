{% extends 'layout_sidebar.html' %}
{% block title %}{% if archived %}Candidati Archiviati{% else %}Gestione Candidati{% endif %}{% endblock %}

<style>
.filter-preset.active {
  background-color: #0d6efd !important;
  color: white !important;
  border-color: #0d6efd !important;
}

.macro-filter {
  border: 2px solid #dee2e6;
}

.macro-filter:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.card-header {
  font-weight: 600;
}

.filter-preset:hover {
  transform: translateY(-1px);
  transition: transform 0.2s ease;
}

/* Stili personalizzati per gli spinner */
#loadingSpinner {
  animation: fadeIn 0.3s ease-in;
}

#filterSpinner {
  z-index: 10;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.spinner-border {
  animation: spinner-border .75s linear infinite;
}

/* Spinner tema scuro */
[data-bs-theme="dark"] .spinner-border {
  color: #0d6efd !important;
}

[data-bs-theme="dark"] #loadingSpinner p {
  color: #adb5bd !important;
}

/* Stili personalizzati per i popover - tema chiaro */
.popover {
  max-width: 300px;
  font-size: 0.875rem;
}

.popover-header {
  font-weight: 600;
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
}

.popover-body {
  color: #6c757d;
  line-height: 1.4;
}

/* Stili per filtri avanzati - tema chiaro */
.collapse .card-body {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
}

/* Tema scuro - popover */
[data-bs-theme="dark"] .popover {
  background-color: #212529 !important;
  border-color: #495057 !important;
}

[data-bs-theme="dark"] .popover-header {
  background-color: #343a40 !important;
  border-bottom-color: #495057 !important;
  color: #fff !important;
}

[data-bs-theme="dark"] .popover-body {
  color: #adb5bd !important;
  background-color: #212529 !important;
}

[data-bs-theme="dark"] .popover .popover-arrow::before {
  border-top-color: #212529 !important;
}

[data-bs-theme="dark"] .popover .popover-arrow::after {
  border-top-color: #212529 !important;
}

/* Popover arrow per posizioni diverse nel tema scuro */
[data-bs-theme="dark"] .bs-popover-top > .popover-arrow::before,
[data-bs-theme="dark"] .bs-popover-top > .popover-arrow::after {
  border-top-color: #212529 !important;
}

[data-bs-theme="dark"] .bs-popover-bottom > .popover-arrow::before,
[data-bs-theme="dark"] .bs-popover-bottom > .popover-arrow::after {
  border-bottom-color: #212529 !important;
}

[data-bs-theme="dark"] .bs-popover-start > .popover-arrow::before,
[data-bs-theme="dark"] .bs-popover-start > .popover-arrow::after {
  border-left-color: #212529 !important;
}

[data-bs-theme="dark"] .bs-popover-end > .popover-arrow::before,
[data-bs-theme="dark"] .bs-popover-end > .popover-arrow::after {
  border-right-color: #212529 !important;
}

/* Stili specifici per popover con classe tema */
.filter-popover.theme-dark {
  background-color: #212529 !important;
  border-color: #495057 !important;
}

.filter-popover.theme-dark .popover-header {
  background-color: #343a40 !important;
  border-bottom-color: #495057 !important;
  color: #fff !important;
}

.filter-popover.theme-dark .popover-body {
  color: #adb5bd !important;
  background-color: #212529 !important;
}

.filter-popover.theme-light {
  background-color: #fff !important;
  border-color: #dee2e6 !important;
}

.filter-popover.theme-light .popover-header {
  background-color: #f8f9fa !important;
  border-bottom-color: #dee2e6 !important;
  color: #212529 !important;
}

/* Tema scuro - filtri avanzati */
[data-bs-theme="dark"] .collapse .card-body {
  background-color: #2c3034 !important;
  border-color: #495057 !important;
}

[data-bs-theme="dark"] .collapse .card-body .form-control,
[data-bs-theme="dark"] .collapse .card-body .form-select {
  background-color: #212529 !important;
  border-color: #495057 !important;
  color: #fff !important;
}

[data-bs-theme="dark"] .collapse .card-body .form-control:focus,
[data-bs-theme="dark"] .collapse .card-body .form-select:focus {
  background-color: #212529 !important;
  border-color: #0d6efd !important;
  color: #fff !important;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
}

[data-bs-theme="dark"] .collapse .card-body .form-control::placeholder,
[data-bs-theme="dark"] .collapse .card-body input.form-control::placeholder,
[data-bs-theme="dark"] .collapse .card-body .filter-input::placeholder {
  color: #adb5bd !important;
  opacity: 1 !important;
}

[data-bs-theme="dark"] .collapse .card-body .text-muted {
  color: #6c757d !important;
}

/* Macrofiltri - tema scuro */
[data-bs-theme="dark"] .macro-filter {
  background-color: #212529;
  border-color: #495057;
  color: #fff;
}

[data-bs-theme="dark"] .macro-filter:focus {
  background-color: #212529;
  border-color: #0d6efd;
  color: #fff;
}

/* Pulsanti filtri preset - tema scuro */
[data-bs-theme="dark"] .filter-preset:not(.active) {
  color: #fff;
  border-color: #495057;
}

[data-bs-theme="dark"] .filter-preset:not(.active):hover {
  background-color: #495057;
  border-color: #6c757d;
}

/* Campo di ricerca globale - tema scuro */
[data-bs-theme="dark"] #searchInput {
  background-color: #212529;
  border-color: #495057;
  color: #fff;
}

[data-bs-theme="dark"] #searchInput:focus {
  background-color: #212529;
  border-color: #0d6efd;
  color: #fff;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

[data-bs-theme="dark"] #searchInput::placeholder {
  color: #adb5bd !important;
}

/* Regole aggiuntive per forzare i placeholder nei filtri avanzati */
[data-bs-theme="dark"] .collapse input::placeholder,
[data-bs-theme="dark"] .collapse .form-control::placeholder,
[data-bs-theme="dark"] .collapse input.filter-input::placeholder {
  color: #adb5bd !important;
  opacity: 1 !important;
}

/* Regola ultra-specifica per sovrascrivare Bootstrap */
[data-bs-theme="dark"] .collapse .card-body input[type="text"]::placeholder {
  color: #adb5bd !important;
  opacity: 1 !important;
}

/* Resoconto candidati - tema scuro */
[data-bs-theme="dark"] #candidatesReport .card {
  background-color: #212529 !important;
  border-color: #495057 !important;
}

[data-bs-theme="dark"] #candidatesReport .text-muted {
  color: #adb5bd !important;
}

[data-bs-theme="dark"] #candidatesReport .text-primary {
  color: #4dabf7 !important;
}

[data-bs-theme="dark"] #candidatesReport .text-success {
  color: #51cf66 !important;
}

[data-bs-theme="dark"] #candidatesReport .text-info {
  color: #74c0fc !important;
}
</style>

{% block main_content %}
<div class="container-fluid my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{% if archived %}Candidati Archiviati{% else %}Elenco Candidati{% endif %}</h2>
    <div class="d-flex gap-2">
      <!-- Pulsanti di esportazione -->
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download"></i> Esporta Lista
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="#" onclick="openExportModal('csv'); return false;">
              <i class="bi bi-file-earmark-spreadsheet text-success"></i> Esporta CSV
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="openExportModal('pdf'); return false;">
              <i class="bi bi-file-earmark-pdf text-danger"></i> Esporta PDF
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Pulsanti navigazione -->
      <div class="btn-group" role="group">
        <a href="/candidati" class="btn {% if not archived %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-people"></i> <span class="d-none d-sm-inline">Candidati Attivi</span>
        </a>
        <a href="/candidati/archiviati" class="btn {% if archived %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
          <i class="bi bi-archive"></i> <span class="d-none d-sm-inline">Candidati Archiviati</span>
        </a>
      </div>
    </div>
  </div>
  
  <!-- Macrofiltri - sempre visibili e non influenzati da reset -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white">
      <h6 class="mb-0"><i class="bi bi-filter-circle"></i> Filtri Principali</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Form</label>
          <select class="form-select macro-filter" id="macro_filter_form_name">
            <option value="">Tutti i Form</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Categoria</label>
          <select class="form-select macro-filter" id="macro_filter_form_category">
            <option value="">Tutte le Categorie</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Sottocategoria</label>
          <select class="form-select macro-filter" id="macro_filter_form_subcategory">
            <option value="">Tutte le Sottocategorie</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modelli di Filtraggio Predefiniti -->
  <div class="card mb-3">
    <div class="card-header bg-info text-white">
      <h6 class="mb-0"><i class="bi bi-magic"></i> Modelli di Filtraggio</h6>
    </div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-outline-primary btn-sm filter-preset" 
                data-preset="recent"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Candidati Recenti"
                data-bs-content="Mostra candidati che si sono registrati negli ultimi 7 giorni dalla data odierna">
          <i class="bi bi-clock"></i> Candidati Recenti (Ultimi 7 giorni)
        </button>
        <button class="btn btn-outline-success btn-sm filter-preset" 
                data-preset="high-score"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Punteggio Alto"
                data-bs-content="Mostra candidati con punteggio totale superiore a 80 punti (eccellente)">
          <i class="bi bi-star"></i> Punteggio Alto (80+)
        </button>
        <button class="btn btn-outline-warning btn-sm filter-preset" 
                data-preset="no-score"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Non Valutati"
                data-bs-content="Mostra candidati che non hanno ancora ricevuto alcun punteggio o valutazione">
          <i class="bi bi-question-circle"></i> Non Valutati
        </button>
        <button class="btn btn-outline-info btn-sm filter-preset" 
                data-preset="available-now"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Disponibili Ora"
                data-bs-content="Mostra candidati la cui disponibilità include la data odierna (disponibilità da ≤ oggi ≤ disponibilità fino)">
          <i class="bi bi-calendar-check"></i> Disponibili Ora
        </button>
        <button class="btn btn-outline-secondary btn-sm filter-preset" 
                data-preset="experienced"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Candidati Esperti"
                data-bs-content="Mostra candidati con 5 o più anni di esperienza di guida">
          <i class="bi bi-award"></i> Esperti (5+ anni guida)
        </button>
        <button class="btn btn-outline-danger btn-sm filter-preset" 
                data-preset="urgent"
                data-bs-toggle="popover" 
                data-bs-placement="top" 
                data-bs-trigger="hover focus"
                data-bs-title="Da Contattare Urgentemente"
                data-bs-content="Mostra candidati recenti (ultimi 7 giorni) che non hanno ancora ricevuto alcuna valutazione">
          <i class="bi bi-exclamation-triangle"></i> Da Contattare
        </button>
        <button class="btn btn-outline-dark btn-sm" id="clearAllFilters">
          <i class="bi bi-x-circle"></i> Pulisci Tutto
        </button>
      </div>
      <small class="text-muted d-block mt-2">
        Usa questi modelli per applicare rapidamente filtri comuni. I filtri principali sopra rimangono sempre attivi.
      </small>
    </div>
  </div>
  
  <div class="mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
      <i class="bi bi-funnel"></i> Filtri avanzati
    </button>
  </div>
  <div class="collapse mb-3" id="filtersCollapse">
    <div class="card card-body bg-light" style="min-width: 0; overflow-x: auto;">
      <!-- Prima riga -->
      <div class="row g-2 mb-2">
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_first_name" placeholder="Nome">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_last_name" placeholder="Cognome">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_email" placeholder="Email">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_phone_number" placeholder="Telefono">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_come_sei_arrivato" placeholder="Come sei arrivato">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_gender" placeholder="Genere">
        </div>
      </div>
      
      <!-- Seconda riga -->
      <div class="row g-2 mb-2">
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_marital_status" placeholder="Stato civile">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_codice_fiscale" placeholder="Codice Fiscale">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <input type="text" class="form-control filter-input" id="filter_city_availability" placeholder="Città Disponibilità">
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <select class="form-select filter-select" id="filter_score_range">
            <option value="">Tutti i Punteggi</option>
            <option value="0-20">0-20 (Molto Basso)</option>
            <option value="20-40">20-40 (Basso)</option>
            <option value="40-60">40-60 (Medio)</option>
            <option value="60-80">60-80 (Buono)</option>
            <option value="80-100">80-100 (Eccellente)</option>
            <option value="no-score">Nessun Punteggio</option>
          </select>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <!-- Spazio per altri filtri futuri -->
        </div>
      </div>
      
      <!-- Terza riga -->
      <div class="row g-2">
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <button class="btn btn-outline-secondary w-100" id="resetAdvancedFilters">
            <i class="bi bi-arrow-clockwise"></i> Reset Filtri Avanzati
          </button>
        </div>
        <!-- Spazio per eventuali filtri futuri -->
        <div class="col-xl-10 col-lg-9 col-md-8 col-sm-6">
          <small class="text-muted">I filtri avanzati si applicano insieme ai filtri principali sopra</small>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-3 position-relative">
    <input type="text" class="form-control" id="searchInput" placeholder="Cerca su tutti i campi...">
    <!-- Spinner piccolo per filtraggio -->
    <div id="filterSpinner" class="position-absolute top-50 end-0 translate-middle-y me-3" style="display: none;">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Filtraggio...</span>
      </div>
    </div>
  </div>
  
  <!-- Resoconto candidati filtrati -->
  <div class="row mb-3" id="candidatesReport" style="display: none;">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="row g-3">
            <div class="col-md-2 col-sm-4 col-6">
              <div class="text-center">
                <div class="h4 mb-1 text-primary fw-bold" id="stat-filtered-total">0</div>
                <div class="small text-muted">Candidati trovati</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6">
              <div class="text-center">
                <div class="h5 mb-1 text-success fw-bold" id="stat-filtered-cv">0</div>
                <div class="small text-muted">Con CV</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-4 col-6">
              <div class="text-center">
                <div class="h5 mb-1 text-info fw-bold" id="stat-filtered-photo">0</div>
                <div class="small text-muted">Con Foto</div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
              <div class="text-center">
                <div class="small text-muted mb-1">Genere più comune</div>
                <span class="badge bg-secondary" id="stat-most-common-gender">-</span>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
              <div class="text-center">
                <div class="small text-muted mb-1">Filtri attivi</div>
                <span class="badge bg-primary" id="stat-active-filters">Nessuno</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="table-responsive">
    <!-- Spinner di caricamento -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Caricamento...</span>
      </div>
      <div class="mt-3">
        <p class="text-muted mb-0">Caricamento candidati in corso...</p>
      </div>
    </div>
    
    <table class="table table-striped table-hover align-middle" id="candidatesTable">
      <thead class="table-light">
        <tr>
          {% set columns = [
            ('first_name', 'Nome'),
            ('last_name', 'Cognome'),
            ('email', 'Email'),
            ('phone_number', 'Telefono'),
            ('come_sei_arrivato', 'Come sei arrivato a noi'),
            ('gender', 'Genere'),
            ('date_of_birth', 'Data di nascita'),
            ('place_of_birth', 'Luogo di nascita'),
            ('nationality', 'Nazionalità'),
            ('marital_status', 'Stato civile'),
            ('height_cm', 'Altezza (cm)'),
            ('weight_kg', 'Peso (kg)'),
            ('tshirt_size', 'Taglia T-shirt'),
            ('shoe_size_eu', 'Numero scarpe'),
            ('address', 'Indirizzo'),
            ('city', 'Città'),
            ('postal_code', 'CAP'),
            ('country_of_residence', 'Paese residenza'),
            ('id_document', 'ID documento'),
            ('id_number', 'Numero documento'),
            ('id_expiry_date', 'Scadenza documento'),
            ('id_country', 'Paese documento'),
            ('additional_document', 'Additional Document'),
            ('codice_fiscale', 'Codice Fiscale'),
            ('permesso_soggiorno', 'Permesso Soggiorno'),
            ('license_country', 'Patente paese'),
            ('license_number', 'Patente numero'),
            ('license_category', 'Drive License'),
            ('license_issue_date', 'Rilascio patente'),
            ('license_expiry_date', 'Scadenza patente'),
            ('years_driving_experience', 'Anni guida'),
            ('auto_moto_munito', 'Auto/Moto munito'),
            ('occupation', 'Occupazione'),
            ('other_experience', 'Altre esperienze'),
            ('availability_from', 'Disponibilità Da'),
            ('availability_till', 'Disponibilità Fino A'),
            ('city_availability', 'City/Cities of Availability'),
            ('language_1', 'Lingua 1'),
            ('proficiency_1', 'Livello 1'),
            ('language_2', 'Lingua 2'),
            ('proficiency_2', 'Livello 2'),
            ('language_3', 'Lingua 3'),
            ('proficiency_3', 'Livello 3'),
            ('form_name', 'Form'),
            ('form_category', 'Categoria Form'),
            ('form_subcategory', 'Sottocategoria Form'),
            ('created_at', 'Creato il'),
            ('total_score', 'Punteggio')
          ] %}
          {% for key, label in columns %}
          <th style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <button class="btn btn-link p-0 sort-btn" data-sort="{{ key }}" title="{{ label }}">
              <span class="d-inline-block text-truncate" style="max-width: 100px; vertical-align: middle;">{{ label }}</span>
              <i class="bi bi-arrow-down-up ms-1"></i>
            </button>
          </th>
          {% endfor %}
          <th style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <span class="d-inline-block text-truncate" style="max-width: 100px; vertical-align: middle;">Curriculum</span>
          </th>
          <th style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <span class="d-inline-block text-truncate" style="max-width: 100px; vertical-align: middle;">Foto</span>
          </th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        <!-- Popolato via JS -->
      </tbody>
    </table>
  </div>
</div>
<!-- Modale immagine -->
<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <img id="imgModalSrc" src="" class="img-fluid rounded shadow" style="max-height:80vh; max-width:90vw;">
    </div>
  </div>
</div>
<!-- Modale modifica con tabs -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifica Candidato</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <input type="hidden" id="edit_id">
          <ul class="nav nav-tabs mb-3" id="editTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-anagrafica" data-bs-toggle="tab" data-bs-target="#anagrafica" type="button" role="tab">Anagrafica</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-contatti" data-bs-toggle="tab" data-bs-target="#contatti" type="button" role="tab">Contatti</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-documenti" data-bs-toggle="tab" data-bs-target="#documenti" type="button" role="tab">Documenti</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-patente" data-bs-toggle="tab" data-bs-target="#patente" type="button" role="tab">Patente</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-lingue" data-bs-toggle="tab" data-bs-target="#lingue" type="button" role="tab">Lingue</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-altro" data-bs-toggle="tab" data-bs-target="#altro" type="button" role="tab">Altro</button>
            </li>
          </ul>
          <div class="tab-content" id="editTabContent">
            <div class="tab-pane fade show active" id="anagrafica" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_first_name" class="form-label">Nome</label>
                  <input type="text" class="form-control" id="edit_first_name" required>
                </div>
                <div class="col-md-6">
                  <label for="edit_last_name" class="form-label">Cognome</label>
                  <input type="text" class="form-control" id="edit_last_name" required>
                </div>
                <div class="col-md-6">
                  <label for="edit_gender" class="form-label">Genere</label>
                  <input type="text" class="form-control" id="edit_gender">
                </div>
                <div class="col-md-6">
                  <label for="edit_date_of_birth" class="form-label">Data di nascita</label>
                  <input type="date" class="form-control" id="edit_date_of_birth">
                </div>
                <div class="col-md-6">
                  <label for="edit_place_of_birth" class="form-label">Luogo di nascita</label>
                  <input type="text" class="form-control" id="edit_place_of_birth">
                </div>
                <div class="col-md-6">
                  <label for="edit_nationality" class="form-label">Nazionalità</label>
                  <input type="text" class="form-control" id="edit_nationality">
                </div>
                <div class="col-md-6">
                  <label for="edit_marital_status" class="form-label">Stato civile</label>
                  <input type="text" class="form-control" id="edit_marital_status">
                </div>
                <div class="col-md-6">
                  <label for="edit_height_cm" class="form-label">Altezza (cm)</label>
                  <input type="number" class="form-control" id="edit_height_cm">
                </div>
                <div class="col-md-6">
                  <label for="edit_weight_kg" class="form-label">Peso (kg)</label>
                  <input type="number" class="form-control" id="edit_weight_kg">
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="contatti" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="edit_email">
                </div>
                <div class="col-md-6">
                  <label for="edit_phone_number" class="form-label">Telefono</label>
                  <input type="text" class="form-control" id="edit_phone_number">
                </div>
                <div class="col-md-6">
                  <label for="edit_address" class="form-label">Indirizzo</label>
                  <input type="text" class="form-control" id="edit_address">
                </div>
                <div class="col-md-6">
                  <label for="edit_city" class="form-label">Città</label>
                  <input type="text" class="form-control" id="edit_city">
                </div>
                <div class="col-md-6">
                  <label for="edit_postal_code" class="form-label">CAP</label>
                  <input type="text" class="form-control" id="edit_postal_code">
                </div>
                <div class="col-md-6">
                  <label for="edit_country_of_residence" class="form-label">Paese residenza</label>
                  <input type="text" class="form-control" id="edit_country_of_residence">
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="documenti" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_id_document" class="form-label">ID doc</label>
                  <input type="text" class="form-control" id="edit_id_document">
                </div>
                <div class="col-md-6">
                  <label for="edit_id_number" class="form-label">Numero doc</label>
                  <input type="text" class="form-control" id="edit_id_number">
                </div>
                <div class="col-md-6">
                  <label for="edit_id_expiry_date" class="form-label">Scadenza doc</label>
                  <input type="date" class="form-control" id="edit_id_expiry_date">
                </div>
                <div class="col-md-6">
                  <label for="edit_id_country" class="form-label">Paese doc</label>
                  <input type="text" class="form-control" id="edit_id_country">
                </div>
                <div class="col-md-6">
                  <label for="edit_additional_document" class="form-label">Documento aggiuntivo</label>
                  <input type="text" class="form-control" id="edit_additional_document">
                </div>
                <div class="col-md-6">
                  <label for="edit_codice_fiscale" class="form-label">Codice Fiscale</label>
                  <input type="text" class="form-control" id="edit_codice_fiscale">
                </div>
                <div class="col-md-6">
                  <label for="edit_permesso_soggiorno" class="form-label">Permesso di soggiorno</label>
                  <input type="text" class="form-control" id="edit_permesso_soggiorno">
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="patente" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_license_country" class="form-label">Patente paese</label>
                  <input type="text" class="form-control" id="edit_license_country">
                </div>
                <div class="col-md-6">
                  <label for="edit_license_number" class="form-label">Patente numero</label>
                  <input type="text" class="form-control" id="edit_license_number">
                </div>
                <div class="col-md-6">
                  <label for="edit_license_category" class="form-label">Drive License</label>
                  <input type="text" class="form-control" id="edit_license_category">
                </div>
                <div class="col-md-6">
                  <label for="edit_license_issue_date" class="form-label">Rilascio patente</label>
                  <input type="date" class="form-control" id="edit_license_issue_date">
                </div>
                <div class="col-md-6">
                  <label for="edit_license_expiry_date" class="form-label">Scadenza patente</label>
                  <input type="date" class="form-control" id="edit_license_expiry_date">
                </div>
                <div class="col-md-6">
                  <label for="edit_years_driving_experience" class="form-label">Anni guida</label>
                  <input type="number" class="form-control" id="edit_years_driving_experience">
                </div>
                <div class="col-md-6">
                  <label for="edit_auto_moto_munito" class="form-label">Auto/Moto munito</label>
                  <input type="text" class="form-control" id="edit_auto_moto_munito">
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="lingue" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="edit_language_1" class="form-label">Lingua 1</label>
                  <input type="text" class="form-control" id="edit_language_1">
                </div>
                <div class="col-md-4">
                  <label for="edit_proficiency_1" class="form-label">Livello 1</label>
                  <input type="text" class="form-control" id="edit_proficiency_1">
                </div>
                <div class="col-md-4">
                  <label for="edit_language_2" class="form-label">Lingua 2</label>
                  <input type="text" class="form-control" id="edit_language_2">
                </div>
                <div class="col-md-4">
                  <label for="edit_proficiency_2" class="form-label">Livello 2</label>
                  <input type="text" class="form-control" id="edit_proficiency_2">
                </div>
                <div class="col-md-4">
                  <label for="edit_language_3" class="form-label">Lingua 3</label>
                  <input type="text" class="form-control" id="edit_language_3">
                </div>
                <div class="col-md-4">
                  <label for="edit_proficiency_3" class="form-label">Livello 3</label>
                  <input type="text" class="form-control" id="edit_proficiency_3">
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="altro" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_come_sei_arrivato" class="form-label">Come sei arrivato a noi?</label>
                  <input type="text" class="form-control" id="edit_come_sei_arrivato">
                </div>
                <div class="col-md-6">
                  <label for="edit_occupation" class="form-label">Occupazione</label>
                  <input type="text" class="form-control" id="edit_occupation">
                </div>
                <div class="col-md-6">
                  <label for="edit_other_experience" class="form-label">Altre esperienze</label>
                  <input type="text" class="form-control" id="edit_other_experience">
                </div>
                <div class="col-md-6">
                  <label for="edit_availability_from" class="form-label">Disponibilità da</label>
                  <input type="date" class="form-control" id="edit_availability_from">
                </div>
                <div class="col-md-6">
                  <label for="edit_availability_till" class="form-label">Disponibilità fino</label>
                  <input type="date" class="form-control" id="edit_availability_till">
                </div>
                <div class="col-md-6">
                  <label for="edit_city_availability" class="form-label">Città/Località di disponibilità</label>
                  <input type="text" class="form-control" id="edit_city_availability">
                </div>
                <div class="col-md-12 mb-3">
                  <label class="form-label">Foto profilo</label>
                  <div class="btn-group mb-2" role="group">
                    <input type="radio" class="btn-check" name="photo_mode" id="photo_mode_upload" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="photo_mode_upload">Carica file</label>
                    <input type="radio" class="btn-check" name="photo_mode" id="photo_mode_camera" autocomplete="off">
                    <label class="btn btn-outline-primary" for="photo_mode_camera">Scatta foto</label>
                  </div>
                  <div id="photo_upload_area">
                    <input class="form-control" type="file" id="edit_profile_photo_file" accept="image/*">
                  </div>
                  <div id="photo_camera_area" style="display:none;">
                    <video id="edit_profile_photo_video" width="200" height="150" autoplay style="border-radius:8px;"></video>
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="takePhotoBtn">Scatta</button>
                    <canvas id="edit_profile_photo_canvas" width="200" height="150" style="display:none;"></canvas>
                  </div>
                  <div class="mt-2">
                    <img id="edit_profile_photo_preview" src="" alt="Anteprima foto" class="rounded shadow" style="max-width:100px; max-height:100px; display:none;">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 mt-3">
            <button type="submit" class="btn btn-success">Salva</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let allCandidates = [];
let filteredCandidates = [];
let currentSort = { key: null, asc: true };

// Carica le opzioni per i filtri dropdown
async function loadFilterOptions() {
  try {
    const resp = await fetch('/api/filter-options');
    const options = await resp.json();
    
    // *** POPOLA I MACROFILTRI ***
    
    // Macrofiltro nomi form
    const macroFormNameSelect = document.getElementById('macro_filter_form_name');
    macroFormNameSelect.innerHTML = '<option value="">Tutti i Form</option>';
    options.form_names.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      macroFormNameSelect.appendChild(option);
    });
    
    // Macrofiltro categorie
    const macroCategorySelect = document.getElementById('macro_filter_form_category');
    macroCategorySelect.innerHTML = '<option value="">Tutte le Categorie</option>';
    options.categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      macroCategorySelect.appendChild(option);
    });
    
    // Macrofiltro sottocategorie
    const macroSubcategorySelect = document.getElementById('macro_filter_form_subcategory');
    macroSubcategorySelect.innerHTML = '<option value="">Tutte le Sottocategorie</option>';
    options.subcategories.forEach(subcategory => {
      const option = document.createElement('option');
      option.value = subcategory;
      option.textContent = subcategory;
      macroSubcategorySelect.appendChild(option);
    });
    
    // *** POPOLA I FILTRI AVANZATI (se esistono ancora) ***
    
    // Mantieni eventuale backward compatibility per filtri avanzati legacy
    const formNameSelect = document.getElementById('filter_form_name');
    if (formNameSelect) {
      formNameSelect.innerHTML = '<option value="">Tutti i Form</option>';
      options.form_names.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        formNameSelect.appendChild(option);
      });
    }
    
    const categorySelect = document.getElementById('filter_form_category');
    if (categorySelect) {
      categorySelect.innerHTML = '<option value="">Tutte le Categorie</option>';
      options.categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }
    
    const subcategorySelect = document.getElementById('filter_form_subcategory');
    if (subcategorySelect) {
      subcategorySelect.innerHTML = '<option value="">Tutte le Sottocategorie</option>';
      options.subcategories.forEach(subcategory => {
        const option = document.createElement('option');
        option.value = subcategory;
        option.textContent = subcategory;
        subcategorySelect.appendChild(option);
      });
    }
    
  } catch (error) {
    console.error('Errore nel caricamento delle opzioni dei filtri:', error);
  }
}

// Funzioni per gestire lo spinner
function showLoadingSpinner() {
  document.getElementById('loadingSpinner').style.display = 'block';
  document.getElementById('candidatesTable').style.display = 'none';
}

function hideLoadingSpinner() {
  document.getElementById('loadingSpinner').style.display = 'none';
  document.getElementById('candidatesTable').style.display = 'table';
}

function showFilterSpinner() {
  document.getElementById('filterSpinner').style.display = 'block';
}

function hideFilterSpinner() {
  document.getElementById('filterSpinner').style.display = 'none';
}

// Funzione per aggiornare il resoconto candidati
function updateCandidatesReport(candidates) {
  const reportDiv = document.getElementById('candidatesReport');
  
  if (!candidates || candidates.length === 0) {
    reportDiv.style.display = 'none';
    return;
  }
  
  // Mostra il resoconto
  reportDiv.style.display = 'block';
  
  // Calcola statistiche
  const total = candidates.length;
  const withCV = candidates.filter(c => c.curriculum_file).length;
  const withPhoto = candidates.filter(c => c.profile_photo).length;
  
  // Trova il genere più comune
  const genderCount = {};
  candidates.forEach(c => {
    if (c.gender) {
      genderCount[c.gender] = (genderCount[c.gender] || 0) + 1;
    }
  });
  
  const mostCommonGender = Object.keys(genderCount).length > 0 
    ? Object.keys(genderCount).reduce((a, b) => genderCount[a] > genderCount[b] ? a : b)
    : 'Non specificato';
  
  // Conta filtri attivi
  const activeFilters = [];
  
  // Controlla macrofiltri
  document.querySelectorAll('.macro-filter').forEach(filter => {
    if (filter.value && filter.value !== '') {
      activeFilters.push(filter.previousElementSibling.textContent.trim());
    }
  });
  
  // Controlla filtri avanzati
  document.querySelectorAll('.filter-input, .filter-select').forEach(filter => {
    if (filter.value && filter.value !== '') {
      const label = filter.closest('.row')?.querySelector('label')?.textContent?.trim() || 
                   filter.closest('.col-md-4, .col-md-3, .col-md-6')?.querySelector('label')?.textContent?.trim();
      if (label && !activeFilters.includes(label)) {
        activeFilters.push(label);
      }
    }
  });
  
  // Controlla ricerca globale
  const searchInput = document.getElementById('searchInput');
  if (searchInput.value && searchInput.value.trim() !== '') {
    activeFilters.push('Ricerca globale');
  }
  
  // Aggiorna i valori nel DOM
  document.getElementById('stat-filtered-total').textContent = total;
  document.getElementById('stat-filtered-cv').textContent = withCV;
  document.getElementById('stat-filtered-photo').textContent = withPhoto;
  document.getElementById('stat-most-common-gender').textContent = mostCommonGender;
  
  const activeFiltersElement = document.getElementById('stat-active-filters');
  if (activeFilters.length > 0) {
    activeFiltersElement.textContent = activeFilters.length === 1 ? activeFilters[0] : `${activeFilters.length} filtri`;
    activeFiltersElement.className = 'badge bg-primary';
  } else {
    activeFiltersElement.textContent = 'Nessuno';
    activeFiltersElement.className = 'badge bg-secondary';
  }
}

async function loadCandidates() {
  try {
    console.log('Caricamento candidati...');
    showLoadingSpinner();
    
    // Determina l'URL dell'API in base alla pagina corrente
    const apiUrl = window.location.pathname.includes('/archiviati') 
      ? '/api/candidates?archived=true' 
      : '/api/candidates';
    
    const resp = await fetch(apiUrl);
    console.log('Risposta ricevuta:', resp.status);
    if (!resp.ok) {
      throw new Error(`HTTP error! status: ${resp.status}`);
    }
    allCandidates = await resp.json();
    console.log('Candidati caricati:', allCandidates.length);
    
    hideLoadingSpinner();
    applyFiltersAndSort();
  } catch (error) {
    console.error('Errore nel caricamento dei candidati:', error);
    hideLoadingSpinner();
    document.querySelector('#candidatesTable tbody').innerHTML = `
      <tr><td colspan="100%" class="text-center text-danger">
        Errore nel caricamento dei candidati: ${error.message}
      </td></tr>
    `;
  }
}
function renderTable(data) {
  console.log('Rendering table con:', data.length, 'candidati');
  const tbody = document.querySelector('#candidatesTable tbody');
  if (!tbody) {
    console.error('Elemento tbody non trovato!');
    return;
  }
  tbody.innerHTML = '';
  data.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.first_name||''}</td>
      <td>${c.last_name||''}</td>
      <td>${c.email||''}</td>
      <td>${c.phone_number||''}</td>
      <td>${c.come_sei_arrivato||''}</td>
      <td>${c.gender||''}</td>
      <td>${c.date_of_birth||''}</td>
      <td>${c.place_of_birth||''}</td>
      <td>${c.nationality||''}</td>
      <td>${c.marital_status||''}</td>
      <td>${c.height_cm||''}</td>
      <td>${c.weight_kg||''}</td>
      <td>${c.tshirt_size||''}</td>
      <td>${c.shoe_size_eu||''}</td>
      <td>${c.address||''}</td>
      <td>${c.city||''}</td>
      <td>${c.postal_code||''}</td>
      <td>${c.country_of_residence||''}</td>
      <td>${c.id_document||''}</td>
      <td>${c.id_number||''}</td>
      <td>${c.id_expiry_date||''}</td>
      <td>${c.id_country||''}</td>
      <td>${c.additional_document||''}</td>
      <td>${c.codice_fiscale||''}</td>
      <td>${c.permesso_soggiorno||''}</td>
      <td>${c.license_country||''}</td>
      <td>${c.license_number||''}</td>
      <td>${c.license_category||''}</td>
      <td>${c.license_issue_date||''}</td>
      <td>${c.license_expiry_date||''}</td>
      <td>${c.years_driving_experience||''}</td>
      <td>${c.auto_moto_munito||''}</td>
      <td>${c.occupation||''}</td>
      <td>${c.other_experience||''}</td>
      <td>${c.availability_from||''}</td>
      <td>${c.availability_till||''}</td>
      <td>${c.city_availability||''}</td>
      <td>${c.language_1||''}</td>
      <td>${c.proficiency_1||''}</td>
      <td>${c.language_2||''}</td>
      <td>${c.proficiency_2||''}</td>
      <td>${c.language_3||''}</td>
      <td>${c.proficiency_3||''}</td>
      <td>
        ${c.form_name ? `<span class="badge bg-info">${c.form_name}</span>` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        ${c.form_category ? `<span class="badge bg-primary">${c.form_category}</span>` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        ${c.form_subcategory ? `<span class="badge bg-secondary">${c.form_subcategory}</span>` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        ${c.created_at ? new Date(c.created_at).toLocaleDateString('it-IT') : '<span class="text-muted">-</span>'}
      </td>
      <td>
        ${(c.scores_count && c.scores_count > 0) ? 
          `<div class="text-center">
            <span class="badge bg-${(parseFloat(c.total_score) || 0) >= 80 ? 'success' : (parseFloat(c.total_score) || 0) >= 60 ? 'warning' : (parseFloat(c.total_score) || 0) >= 40 ? 'info' : 'danger'}">${c.total_score ? Number(c.total_score).toFixed(1) : '0.0'}</span>
            <br><small class="text-muted">${c.scores_count} punt${c.scores_count === 1 ? 'o' : 'i'}</small>
          </div>` : 
          '<span class="text-muted">Non valutato</span>'
        }
      </td>
      <td>
        ${c.curriculum_file ? `
          <div class="btn-group btn-group-sm" role="group">
            <a href="/curriculum/view/${c.curriculum_file.split('/').pop()}" class="btn btn-outline-info" title="Visualizza PDF">
              <i class='bi bi-eye'></i>
            </a>
            <a href="${c.curriculum_file}" download class="btn btn-outline-success" title="Scarica PDF">
              <i class='bi bi-download'></i>
            </a>
          </div>
        ` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        ${c.profile_photo ? `<img src="${c.profile_photo}" class="rounded-circle shadow-sm" style="width:40px;height:40px;object-fit:cover;cursor:pointer;" onclick="showImgModal('${c.profile_photo}')">` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        <div class="btn-group" role="group">
          <a href="/candidati/${c.id}/profilo" class="btn btn-sm btn-primary"><i class="bi bi-person-lines-fill"></i> Profilo</a>
          <a href="/candidati/${c.id}/punteggi" class="btn btn-sm btn-info"><i class="bi bi-star"></i> Punteggi</a>
          ${getArchiveButton(c)}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function applyFiltersAndSort() {
  showFilterSpinner();
  
  // Aggiungi un piccolo delay per permettere al DOM di aggiornare lo spinner
  setTimeout(() => {
    let filtered = allCandidates;
    
    console.log('Tutti i candidati:', allCandidates.length);
    if(allCandidates.length > 0) {
      console.log('Esempio dati candidato completo:', allCandidates[0]);
      console.log('Esempio dati candidato:', {
        name: allCandidates[0].first_name + ' ' + allCandidates[0].last_name,
        created_at: allCandidates[0].created_at,
        total_score: allCandidates[0].total_score,
        scores_count: allCandidates[0].scores_count,
        scores_object: allCandidates[0].scores,
        typeof_total_score: typeof allCandidates[0].total_score,
        typeof_scores_count: typeof allCandidates[0].scores_count
      });
    }
  
  // *** MACROFILTRI - Applicati sempre per primi ***
  
  // Filtro per Form
  const formFilter = document.getElementById('macro_filter_form_name').value;
  if (formFilter) {
    filtered = filtered.filter(c => (c.form_name || '') === formFilter);
    console.log('Filtro form applicato:', formFilter, '- Risultati:', filtered.length);
  }
  
  // Filtro per Categoria
  const categoryFilter = document.getElementById('macro_filter_form_category').value;
  if (categoryFilter) {
    filtered = filtered.filter(c => (c.form_category || '') === categoryFilter);
    console.log('Filtro categoria applicato:', categoryFilter, '- Risultati:', filtered.length);
  }
  
  // Filtro per Sottocategoria
  const subcategoryFilter = document.getElementById('macro_filter_form_subcategory').value;
  if (subcategoryFilter) {
    filtered = filtered.filter(c => (c.form_subcategory || '') === subcategoryFilter);
    console.log('Filtro sottocategoria applicato:', subcategoryFilter, '- Risultati:', filtered.length);
  }
  
  // *** FILTRI PRESET SPECIALI ***
  if (currentFilterPreset) {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    switch(currentFilterPreset) {
      case 'recent':
        filtered = filtered.filter(c => {
          const createdAt = new Date(c.created_at);
          return createdAt >= weekAgo;
        });
        console.log('Filtro preset "recent" applicato - Risultati:', filtered.length);
        break;
        
      case 'high-score':
        filtered = filtered.filter(c => {
          const score = parseFloat(c.total_score) || 0;
          const hasValidScore = c.scores_count > 0 && !isNaN(score);
          return hasValidScore && score >= 80;
        });
        console.log('Filtro preset "high-score" applicato - Risultati:', filtered.length);
        break;
        
      case 'no-score':
        filtered = filtered.filter(c => {
          const hasValidScore = c.scores_count > 0;
          return !hasValidScore;
        });
        console.log('Filtro preset "no-score" applicato - Risultati:', filtered.length);
        break;
        
      case 'available-now':
        filtered = filtered.filter(c => {
          if (!c.availability_from || !c.availability_till) return false;
          const availFrom = new Date(c.availability_from);
          const availTill = new Date(c.availability_till);
          return availFrom <= today && availTill >= today;
        });
        console.log('Filtro preset "available-now" applicato - Risultati:', filtered.length);
        break;
        
      case 'experienced':
        filtered = filtered.filter(c => {
          const experience = parseInt(c.years_driving_experience) || 0;
          return experience >= 5;
        });
        console.log('Filtro preset "experienced" applicato - Risultati:', filtered.length);
        break;
        
      case 'urgent':
        filtered = filtered.filter(c => {
          const hasScore = (c.scores_count > 0);
          const isRecent = new Date(c.created_at) >= weekAgo;
          return !hasScore && isRecent;
        });
        console.log('Filtro preset "urgent" applicato - Risultati:', filtered.length);
        break;
    }
  }
  
  // *** FILTRI AVANZATI ***
  
  // Applica filtri da input di testo
  document.querySelectorAll('.filter-input').forEach(input => {
    const val = input.value.toLowerCase();
    const key = input.id.replace('filter_','');
    if(val) {
      filtered = filtered.filter(c => (c[key]||'').toString().toLowerCase().includes(val));
    }
  });
  
  // Applica filtri da dropdown (escluso il filtro punteggio)
  document.querySelectorAll('.filter-select').forEach(select => {
    const val = select.value;
    const key = select.id.replace('filter_','');
    
    // Gestisci il filtro per punteggio separatamente
    if(key === 'score_range') {
      if(val) {
        console.log('Filtrando per punteggio:', val);
        console.log('Candidati prima del filtro:', filtered.length);
        
        filtered = filtered.filter(c => {
          const score = parseFloat(c.total_score);
          const scoresCount = parseInt(c.scores_count) || 0;
          
          // Se total_score è NaN, significa che il candidato non ha punteggi
          const hasValidScore = !isNaN(score) && scoresCount > 0;
          const scoreValue = hasValidScore ? score : 0;
          
          console.log(`Candidato ${c.first_name} ${c.last_name}: score=${scoreValue}, scoresCount=${scoresCount}, hasValidScore=${hasValidScore}`);
          
          let result = false;
          switch(val) {
            case '0-20':
              result = hasValidScore && scoreValue >= 0 && scoreValue <= 20;
              break;
            case '20-40':
              result = hasValidScore && scoreValue > 20 && scoreValue <= 40;
              break;
            case '40-60':
              result = hasValidScore && scoreValue > 40 && scoreValue <= 60;
              break;
            case '60-80':
              result = hasValidScore && scoreValue > 60 && scoreValue <= 80;
              break;
            case '80-100':
              result = hasValidScore && scoreValue > 80 && scoreValue <= 100;
              break;
            case 'no-score':
              result = !hasValidScore || scoresCount === 0;
              break;
            default:
              result = true;
          }
          
          if(result) {
            console.log(`✓ Candidato ${c.first_name} ${c.last_name} passa il filtro`);
          }
          
          return result;
        });
        console.log('Candidati dopo filtro punteggio:', filtered.length);
      }
    } else if(val) {
      // Altri filtri dropdown standard
      filtered = filtered.filter(c => (c[key]||'').toString() === val);
    }
  });
  
  const q = document.getElementById('searchInput').value.toLowerCase();
  if(q) {
    filtered = filtered.filter(c =>
      Object.values(c).some(v => (v||'').toString().toLowerCase().includes(q))
    );
  }
  
  if(currentSort.key) {
    filtered = filtered.slice().sort((a,b) => {
      let va = (a[currentSort.key]||'').toString().toLowerCase();
      let vb = (b[currentSort.key]||'').toString().toLowerCase();
      
      // Gestione speciale per l'ordinamento numerico del punteggio
      if(currentSort.key === 'total_score') {
        va = parseFloat(a.total_score) || 0;
        vb = parseFloat(b.total_score) || 0;
        return currentSort.asc ? va - vb : vb - va;
      }
      
      if(va < vb) return currentSort.asc ? -1 : 1;
      if(va > vb) return currentSort.asc ? 1 : -1;
      return 0;
    });
  }
  renderTable(filtered);
  
  // Aggiorna la variabile globale dei candidati filtrati
  filteredCandidates = filtered;
  
  // Aggiorna il resoconto candidati
  updateCandidatesReport(filtered);
  
  // Aggiorna il conteggio nel modale di esportazione
  updateFilteredCount();
  
  // Nascondi lo spinner di filtraggio
  hideFilterSpinner();
  }, 50); // Delay di 50ms per permettere al DOM di aggiornare lo spinner
}

// Event listeners per input di testo
document.querySelectorAll('.filter-input').forEach(input => {
  input.addEventListener('input', function() {
    currentFilterPreset = null; // Reset preset quando l'utente modifica manualmente
    document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
    applyFiltersAndSort();
  });
});

// Event listeners per dropdown
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', function() {
      currentFilterPreset = null; // Reset preset quando l'utente modifica manualmente
      document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
      applyFiltersAndSort();
    });
  });
  
  // Listener specifico per il filtro punteggio
  const scoreFilter = document.getElementById('filter_score_range');
  if (scoreFilter) {
    scoreFilter.addEventListener('change', function() {
      console.log('Filtro punteggio cambiato a:', this.value);
      currentFilterPreset = null; // Reset preset quando l'utente modifica manualmente
      document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
      applyFiltersAndSort();
    });
  }
});

document.getElementById('searchInput').addEventListener('input', function() {
  currentFilterPreset = null; // Reset preset quando l'utente modifica manualmente
  document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
  applyFiltersAndSort();
});

// Reset solo filtri avanzati (non i macrofiltri)
const resetAdvancedFiltersBtn = document.getElementById('resetAdvancedFilters');
if (resetAdvancedFiltersBtn) {
  // Reset solo filtri avanzati (non i macrofiltri)
  resetAdvancedFiltersBtn.onclick = function() {
    document.querySelectorAll('.filter-input').forEach(input => input.value = '');
    document.querySelectorAll('.filter-select').forEach(select => select.value = '');
    document.getElementById('searchInput').value = '';
    currentFilterPreset = null; // Reset del preset attivo
    document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
    applyFiltersAndSort();
  };
}

// Reset completo di tutti i filtri (inclusi macrofiltri)
const clearAllFiltersBtn = document.getElementById('clearAllFilters');
if (clearAllFiltersBtn) {
  clearAllFiltersBtn.onclick = function() {
    // Reset filtri avanzati
    document.querySelectorAll('.filter-input').forEach(input => input.value = '');
    document.querySelectorAll('.filter-select').forEach(select => select.value = '');
    document.getElementById('searchInput').value = '';
    
    // Reset macrofiltri
    document.querySelectorAll('.macro-filter').forEach(select => select.value = '');
    
    // Reset preset
    currentFilterPreset = null;
    document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
    
    applyFiltersAndSort();
  };
}

// Gestione macrofiltri
document.querySelectorAll('.macro-filter').forEach(filter => {
  filter.addEventListener('change', function() {
    console.log('Macrofiltro cambiato:', this.id, '=', this.value);
    applyFiltersAndSort();
  });
});

// Gestione modelli di filtraggio predefiniti
document.querySelectorAll('.filter-preset').forEach(btn => {
  btn.addEventListener('click', function() {
    const preset = this.getAttribute('data-preset');
    
    // Rimuovi classe active da tutti i bottoni preset
    document.querySelectorAll('.filter-preset').forEach(b => b.classList.remove('active'));
    
    // Aggiungi classe active al bottone cliccato
    this.classList.add('active');
    
    applyFilterPreset(preset);
  });
});

// Funzione per applicare modelli di filtraggio predefiniti
function applyFilterPreset(preset) {
  // Prima reset solo i filtri avanzati (non i macrofiltri)
  document.querySelectorAll('.filter-input').forEach(input => input.value = '');
  document.querySelectorAll('.filter-select').forEach(select => select.value = '');
  document.getElementById('searchInput').value = '';
  
  // Reset del preset attivo
  currentFilterPreset = null;
  
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  switch(preset) {
    case 'recent':
      // Candidati degli ultimi 7 giorni - implementato tramite filtro nella funzione applyFiltersAndSort
      currentFilterPreset = 'recent';
      break;
      
    case 'high-score':
      currentFilterPreset = 'high-score';
      break;
      
    case 'no-score':
      currentFilterPreset = 'no-score';
      break;
      
    case 'available-now':
      // Candidati disponibili ora - implementato tramite filtro nella funzione applyFiltersAndSort
      currentFilterPreset = 'available-now';
      break;
      
    case 'experienced':
      // Esperti con 5+ anni di guida - implementato tramite filtro nella funzione applyFiltersAndSort
      currentFilterPreset = 'experienced';
      break;
      
    case 'urgent':
      // Da contattare (senza punteggio e recenti) - implementato tramite filtro nella funzione applyFiltersAndSort
      currentFilterPreset = 'urgent';
      break;
  }
  
  applyFiltersAndSort();
}

// Variabile globale per tenere traccia del preset attivo
let currentFilterPreset = null;
document.querySelectorAll('.sort-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const key = this.getAttribute('data-sort');
    if(currentSort.key === key) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    applyFiltersAndSort();
  });
});
function openEdit(id) {
  const c = allCandidates.find(x=>x.id===id);
  if(!c) return;
  document.getElementById('edit_id').value = c.id;
  document.getElementById('edit_first_name').value = c.first_name||'';
  document.getElementById('edit_last_name').value = c.last_name||'';
  document.getElementById('edit_email').value = c.email||'';
  document.getElementById('edit_phone_number').value = c.phone_number||'';
  document.getElementById('edit_come_sei_arrivato').value = c.come_sei_arrivato||'';
  document.getElementById('edit_gender').value = c.gender||'';
  document.getElementById('edit_date_of_birth').value = c.date_of_birth||'';
  document.getElementById('edit_place_of_birth').value = c.place_of_birth||'';
  document.getElementById('edit_nationality').value = c.nationality||'';
  document.getElementById('edit_marital_status').value = c.marital_status||'';
  document.getElementById('edit_height_cm').value = c.height_cm||'';
  document.getElementById('edit_weight_kg').value = c.weight_kg||'';
  document.getElementById('edit_tshirt_size').value = c.tshirt_size||'';
  document.getElementById('edit_shoe_size_eu').value = c.shoe_size_eu||'';
  document.getElementById('edit_address').value = c.address||'';
  document.getElementById('edit_city').value = c.city||'';
  document.getElementById('edit_postal_code').value = c.postal_code||'';
  document.getElementById('edit_country_of_residence').value = c.country_of_residence||'';
  document.getElementById('edit_id_document').value = c.id_document||'';
  document.getElementById('edit_id_number').value = c.id_number||'';
  document.getElementById('edit_id_expiry_date').value = c.id_expiry_date||'';
  document.getElementById('edit_id_country').value = c.id_country||'';
  document.getElementById('edit_additional_document').value = c.additional_document||'';
  document.getElementById('edit_codice_fiscale').value = c.codice_fiscale||'';
  document.getElementById('edit_permesso_soggiorno').value = c.permesso_soggiorno||'';
  document.getElementById('edit_license_country').value = c.license_country||'';
  document.getElementById('edit_license_number').value = c.license_number||'';
  document.getElementById('edit_license_category').value = c.license_category||'';
  document.getElementById('edit_license_issue_date').value = c.license_issue_date||'';
  document.getElementById('edit_license_expiry_date').value = c.license_expiry_date||'';
  document.getElementById('edit_years_driving_experience').value = c.years_driving_experience||'';
  document.getElementById('edit_auto_moto_munito').value = c.auto_moto_munito||'';
  document.getElementById('edit_occupation').value = c.occupation||'';
  document.getElementById('edit_other_experience').value = c.other_experience||'';
  document.getElementById('edit_availability_from').value = c.availability_from||'';
  document.getElementById('edit_availability_till').value = c.availability_till||'';
  document.getElementById('edit_city_availability').value = c.city_availability||'';
  document.getElementById('edit_language_1').value = c.language_1||'';
  document.getElementById('edit_proficiency_1').value = c.proficiency_1||'';
  document.getElementById('edit_language_2').value = c.language_2||'';
  document.getElementById('edit_proficiency_2').value = c.proficiency_2||'';
  document.getElementById('edit_language_3').value = c.language_3||'';
  document.getElementById('edit_proficiency_3').value = c.proficiency_3||'';
  new bootstrap.Modal(document.getElementById('editModal')).show();
}
document.getElementById('editForm').onsubmit = async function(e) {
  e.preventDefault();
  const id = document.getElementById('edit_id').value;
  const payload = {
    first_name: document.getElementById('edit_first_name').value,
    last_name: document.getElementById('edit_last_name').value,
    email: document.getElementById('edit_email').value,
    phone_number: document.getElementById('edit_phone_number').value,
    come_sei_arrivato: document.getElementById('edit_come_sei_arrivato').value,
    gender: document.getElementById('edit_gender').value,
    date_of_birth: document.getElementById('edit_date_of_birth').value,
    place_of_birth: document.getElementById('edit_place_of_birth').value,
    nationality: document.getElementById('edit_nationality').value,
    marital_status: document.getElementById('edit_marital_status').value,
    height_cm: document.getElementById('edit_height_cm').value,
    weight_kg: document.getElementById('edit_weight_kg').value,
    tshirt_size: document.getElementById('edit_tshirt_size').value,
    shoe_size_eu: document.getElementById('edit_shoe_size_eu').value,
    address: document.getElementById('edit_address').value,
    city: document.getElementById('edit_city').value,
    postal_code: document.getElementById('edit_postal_code').value,
    country_of_residence: document.getElementById('edit_country_of_residence').value,
    id_document: document.getElementById('edit_id_document').value,
    id_number: document.getElementById('edit_id_number').value,
    id_expiry_date: document.getElementById('edit_id_expiry_date').value,
    id_country: document.getElementById('edit_id_country').value,
    additional_document: document.getElementById('edit_additional_document').value,
    codice_fiscale: document.getElementById('edit_codice_fiscale').value,
    permesso_soggiorno: document.getElementById('edit_permesso_soggiorno').value,
    license_country: document.getElementById('edit_license_country').value,
    license_number: document.getElementById('edit_license_number').value,
    license_category: document.getElementById('edit_license_category').value,
    license_issue_date: document.getElementById('edit_license_issue_date').value,
    license_expiry_date: document.getElementById('edit_license_expiry_date').value,
    years_driving_experience: document.getElementById('edit_years_driving_experience').value,
    auto_moto_munito: document.getElementById('edit_auto_moto_munito').value,
    occupation: document.getElementById('edit_occupation').value,
    other_experience: document.getElementById('edit_other_experience').value,
    availability_from: document.getElementById('edit_availability_from').value,
    availability_till: document.getElementById('edit_availability_till').value,
    city_availability: document.getElementById('edit_city_availability').value,
    language_1: document.getElementById('edit_language_1').value,
    proficiency_1: document.getElementById('edit_proficiency_1').value,
    language_2: document.getElementById('edit_language_2').value,
    proficiency_2: document.getElementById('edit_proficiency_2').value,
    language_3: document.getElementById('edit_language_3').value,
    proficiency_3: document.getElementById('edit_proficiency_3').value
  };
  // Handle photo upload
  const formData = new FormData();
  for (const k in payload) formData.append(k, payload[k]);
  if (capturedPhotoBlob) {
    formData.append('profile_photo', capturedPhotoBlob, 'profile.jpg');
  }
  await fetch(`/api/candidates/${id}`, {
    method: 'PUT',
    body: formData
  });
  bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
  loadCandidates();
};

// Carica sia i candidati che le opzioni dei filtri all'avvio
async function initializePage() {
  await loadFilterOptions();
  await loadCandidates();
}

initializePage();

// Tooltip Bootstrap per i titoli delle colonne
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
tooltipTriggerList.forEach(function (el) {
  new bootstrap.Tooltip(el);
});

// Inizializza i popover per i modelli di filtraggio
const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
let popoverInstances = [];

function initializePopovers() {
  // Distruggi istanze esistenti
  popoverInstances.forEach(instance => {
    if (instance) instance.dispose();
  });
  popoverInstances = [];
  
  // Rileva il tema corrente
  const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
  
  // Crea nuove istanze con configurazione appropriata per il tema
  popoverTriggerList.forEach(function (popoverTriggerEl) {
    const popoverInstance = new bootstrap.Popover(popoverTriggerEl, {
      html: true,
      delay: { show: 300, hide: 100 },
      customClass: `filter-popover theme-${currentTheme}`,
      template: `<div class="popover" data-bs-theme="${currentTheme}" role="tooltip">
                   <div class="popover-arrow"></div>
                   <h3 class="popover-header"></h3>
                   <div class="popover-body"></div>
                 </div>`
    });
    popoverInstances.push(popoverInstance);
  });
}

// Inizializza i popover al caricamento
initializePopovers();

// Gestione cambio tema per i popover
const themeObserver = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
      // Reinizializza i popover quando cambia il tema
      setTimeout(() => {
        initializePopovers();
      }, 100); // Piccolo delay per assicurarsi che il tema sia completamente applicato
    }
  });
});

// Osserva i cambiamenti del tema sul documento
themeObserver.observe(document.documentElement, {
  attributes: true,
  attributeFilter: ['data-bs-theme']
});

// Gestione upload/scatto foto profilo
const photoModeUpload = document.getElementById('photo_mode_upload');
const photoModeCamera = document.getElementById('photo_mode_camera');
const photoUploadArea = document.getElementById('photo_upload_area');
const photoCameraArea = document.getElementById('photo_camera_area');
const profilePhotoFile = document.getElementById('edit_profile_photo_file');
const profilePhotoVideo = document.getElementById('edit_profile_photo_video');
const profilePhotoCanvas = document.getElementById('edit_profile_photo_canvas');
const profilePhotoPreview = document.getElementById('edit_profile_photo_preview');
let mediaRecorder;
let photoBlob;

photoModeUpload.addEventListener('change', function() {
  if(this.checked) {
    photoUploadArea.style.display = 'block';
    photoCameraArea.style.display = 'none';
    profilePhotoFile.value = '';
    profilePhotoPreview.style.display = 'none';
  }
});

photoModeCamera.addEventListener('change', function() {
  if(this.checked) {
    photoUploadArea.style.display = 'none';
    photoCameraArea.style.display = 'block';
    startCamera();
  }
});

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  profilePhotoVideo.srcObject = stream;
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.addEventListener('dataavailable', function(e) {
    photoBlob = e.data;
    const url = URL.createObjectURL(photoBlob);
    profilePhotoPreview.src = url;
    profilePhotoPreview.style.display = 'block';
  });
  mediaRecorder.start();
}

document.getElementById('takePhotoBtn').addEventListener('click', function() {
  mediaRecorder.stop();
  profilePhotoVideo.srcObject.getTracks().forEach(track => track.stop());
});

profilePhotoFile.addEventListener('change', function() {
  const file = this.files[0];
  if(file) {
    const url = URL.createObjectURL(file);
    profilePhotoPreview.src = url;
    profilePhotoPreview.style.display = 'block';
  }
});

document.getElementById('editForm').addEventListener('submit', function() {
  const photoMode = document.querySelector('input[name="photo_mode"]:checked').id;
  if(photoMode === 'photo_mode_camera' && photoBlob) {
    const formData = new FormData();
    formData.append('profile_photo', photoBlob, 'profile_photo.jpg');
    fetch(`/api/candidates/${document.getElementById('edit_id').value}/photo`, {
      method: 'POST',
      body: formData
    });
  }
});

// === Webcam/Profile Photo Logic ===
let webcamStream = null;
const photoInput = document.createElement('input');
photoInput.type = 'file';
photoInput.accept = 'image/*';
photoInput.style.display = 'none';
document.body.appendChild(photoInput);

let capturedPhotoBlob = null;

function setPhotoPreview(src) {
  const img = document.getElementById('photoPreview');
  if (img) img.src = src || '';
}

function stopWebcam() {
  if (webcamStream) {
    webcamStream.getTracks().forEach(track => track.stop());
    webcamStream = null;
  }
  const video = document.getElementById('webcamVideo');
  if (video) video.srcObject = null;
}

function startWebcam() {
  const video = document.getElementById('webcamVideo');
  if (!video) return;
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      webcamStream = stream;
      video.srcObject = stream;
      video.play();
    })
    .catch(() => {
      alert('Impossibile accedere alla webcam.');
    });
}

// Switch between upload and webcam
function setPhotoMode(mode) {
  document.getElementById('webcamContainer').style.display = (mode === 'webcam') ? '' : 'none';
  document.getElementById('photoUploadContainer').style.display = (mode === 'upload') ? '' : 'none';
  if (mode === 'webcam') {
    startWebcam();
  } else {
    stopWebcam();
  }
}

const photoModeUploadBtn = document.getElementById('photoModeUpload');
if (photoModeUploadBtn) photoModeUploadBtn.onclick = () => setPhotoMode('upload');

const photoModeWebcamBtn = document.getElementById('photoModeWebcam');
if (photoModeWebcamBtn) photoModeWebcamBtn.onclick = () => setPhotoMode('webcam');

const photoUploadBtnEl = document.getElementById('photoUploadBtn');
if (photoUploadBtnEl) photoUploadBtnEl.onclick = () => photoInput.click();
photoInput.onchange = function() {
  if (this.files && this.files[0]) {
    const reader = new FileReader();
    reader.onload = e => setPhotoPreview(e.target.result);
    reader.readAsDataURL(this.files[0]);
    capturedPhotoBlob = this.files[0];
  }
};

const capturePhotoBtn = document.getElementById('capturePhotoBtn');
if (capturePhotoBtn) {
  capturePhotoBtn.onclick = function() {
    const video = document.getElementById('webcamVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    canvas.toBlob(blob => {
      capturedPhotoBlob = blob;
      setPhotoPreview(URL.createObjectURL(blob));
    }, 'image/jpeg');
  };
}

const removePhotoBtn = document.getElementById('removePhotoBtn');
if (removePhotoBtn) {
  removePhotoBtn.onclick = function() {
    setPhotoPreview('');
    capturedPhotoBlob = null;
    photoInput.value = '';
  };
}

// On modal close, stop webcam
const editModalEl = document.getElementById('editModal');
if (editModalEl) editModalEl.addEventListener('hidden.bs.modal', stopWebcam);

// Funzioni per archiviazione
function getArchiveButton(candidate) {
  const isArchived = candidate.archived || false;
  const currentPage = window.location.pathname.includes('/archiviati');
  
  if (currentPage) {
    // Se siamo nella vista archiviati, mostra pulsante "Ripristina"
    return `<button class="btn btn-sm btn-success" onclick="toggleArchive(${candidate.id}, false)" title="Ripristina candidato">
              <i class="bi bi-arrow-counterclockwise"></i> Ripristina
            </button>`;
  } else {
    // Se siamo nella vista attivi, mostra pulsante "Archivia"
    return `<button class="btn btn-sm btn-warning" onclick="toggleArchive(${candidate.id}, true)" title="Archivia candidato">
              <i class="bi bi-archive"></i> Archivia
            </button>`;
  }
}

async function toggleArchive(candidateId, archived) {
  const action = archived ? 'archiviare' : 'ripristinare';
  
  if (!confirm(`Sei sicuro di voler ${action} questo candidato?`)) {
    return;
  }
  
  try {
    const response = await fetch(`/api/candidates/${candidateId}/archive`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ archived: archived })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Ricarica la lista candidati
      loadCandidates();
      
      // Mostra messaggio di successo
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = `
        ${data.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Inserisci l'alert dopo l'header
      const header = document.querySelector('h2');
      if (header) {
        header.insertAdjacentElement('afterend', alertDiv);
        
        // Rimuovi l'alert dopo 3 secondi
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 3000);
      }
    } else {
      alert('Errore durante l operazione: ' + (data.error || 'Errore sconosciuto'));
    }
  } catch (error) {
    console.error('Errore:', error);
    alert('Errore di rete durante l operazione');
  }
}

// Funzioni per l'esportazione
function openExportModal(type) {
  console.log('Opening export modal for type:', type);
  const modal = new bootstrap.Modal(document.getElementById('fieldSelectionModal'));
  modal.show();
  document.getElementById('exportType').value = type;
}

function exportCSV() {
  const modal = new bootstrap.Modal(document.getElementById('fieldSelectionModal'));
  modal.show();
  document.getElementById('exportType').value = 'csv';
}

function exportPDF() {
  const modal = new bootstrap.Modal(document.getElementById('fieldSelectionModal'));
  modal.show();
  document.getElementById('exportType').value = 'pdf';
}

function processExport() {
  const exportType = document.getElementById('exportType').value;
  console.log('Processing export for type:', exportType);
  
  const selectedFields = [];
  
  // Raccogli i campi selezionati
  const checkboxes = document.querySelectorAll('#fieldSelectionModal input[type="checkbox"]:checked');
  checkboxes.forEach(function(checkbox) {
    selectedFields.push(checkbox.value);
  });
  
  console.log('Selected fields:', selectedFields);
  
  if (selectedFields.length === 0) {
    alert('Seleziona almeno un campo da esportare');
    return;
  }
  
  // Ottieni il tipo di esportazione (tutti o filtrati)
  const exportScope = document.querySelector('input[name="export_scope"]:checked').value;
  console.log('Export scope:', exportScope);
  
  // Crea il form per l'esportazione
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/candidati/export/${exportType}`;
  
  console.log('Form action:', form.action);
  
  // Aggiungi il tipo di esportazione
  const exportTypeInput = document.createElement('input');
  exportTypeInput.type = 'hidden';
  exportTypeInput.name = 'export_type';
  exportTypeInput.value = exportScope;
  form.appendChild(exportTypeInput);
  
  // Se esportazione filtrata, aggiungi gli ID dei candidati visibili
  if (exportScope === 'filtered') {
    filteredCandidates.forEach(candidate => {
      const candidateIdInput = document.createElement('input');
      candidateIdInput.type = 'hidden';
      candidateIdInput.name = 'candidate_ids';
      candidateIdInput.value = candidate.id;
      form.appendChild(candidateIdInput);
    });
    console.log('Added', filteredCandidates.length, 'candidate IDs for filtered export');
  }
  
  // Aggiungi stato archiviato se necessario
  const archivedInput = document.createElement('input');
  archivedInput.type = 'hidden';
  archivedInput.name = 'archived';
  archivedInput.value = window.location.pathname.includes('/archiviati') ? 'true' : 'false';
  form.appendChild(archivedInput);
  
  // Aggiungi i campi selezionati
  selectedFields.forEach(field => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'fields';
    input.value = field;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  console.log('Submitting form...');
  form.submit();
  document.body.removeChild(form);
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('fieldSelectionModal'));
  modal.hide();
}

// Aggiorna il conteggio dei candidati filtrati nel modale
function updateFilteredCount() {
  const countElement = document.getElementById('filtered_count');
  if (countElement) {
    const count = filteredCandidates.length;
    countElement.textContent = `(${count} candidat${count !== 1 ? 'i' : 'o'} attualmente visualizzat${count !== 1 ? 'i' : 'o'})`;
  }
}

function selectAllFields() {
  const checkboxes = document.querySelectorAll('#fieldSelectionModal input[type="checkbox"]');
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = true;
  });
}

function deselectAllFields() {
  const checkboxes = document.querySelectorAll('#fieldSelectionModal input[type="checkbox"]');
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = false;
  });
}

// Event listener per aggiornare il conteggio quando si apre il modale
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('fieldSelectionModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', function() {
      updateFilteredCount();
    });
  }
});
</script>

<!-- Modal per la selezione dei campi -->
<div class="modal fade" id="fieldSelectionModal" tabindex="-1" aria-labelledby="fieldSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fieldSelectionModalLabel">Seleziona Campi da Esportare</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="exportType" value="">
        
        <div class="row mb-3">
          <div class="col-12">
            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllFields()">Seleziona Tutti</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllFields()">Deseleziona Tutti</button>
          </div>
        </div>
        
        <div class="row">
          <!-- Dati Personali -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Dati Personali</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="name" id="field_name" checked>
              <label class="form-check-label" for="field_name">Nome</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="surname" id="field_surname" checked>
              <label class="form-check-label" for="field_surname">Cognome</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="birth_date" id="field_birth_date">
              <label class="form-check-label" for="field_birth_date">Data di Nascita</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="birth_place" id="field_birth_place">
              <label class="form-check-label" for="field_birth_place">Luogo di Nascita</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="nationality" id="field_nationality">
              <label class="form-check-label" for="field_nationality">Nazionalità</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="residence" id="field_residence">
              <label class="form-check-label" for="field_residence">Residenza</label>
            </div>
          </div>
          
          <!-- Contatti -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Contatti</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="email" id="field_email" checked>
              <label class="form-check-label" for="field_email">Email</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="phone" id="field_phone" checked>
              <label class="form-check-label" for="field_phone">Telefono</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="gender" id="field_gender">
              <label class="form-check-label" for="field_gender">Genere</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="marital_status" id="field_marital_status">
              <label class="form-check-label" for="field_marital_status">Stato Civile</label>
            </div>
          </div>
        </div>
        
        <hr class="my-4">
        
        <div class="row">
          <!-- Informazioni Professionali -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Informazioni Professionali</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="occupation" id="field_occupation" checked>
              <label class="form-check-label" for="field_occupation">Occupazione</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="city_availability" id="field_city_availability">
              <label class="form-check-label" for="field_city_availability">Città Disponibilità</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="come_sei_arrivato" id="field_come_sei_arrivato">
              <label class="form-check-label" for="field_come_sei_arrivato">Come sei arrivato</label>
            </div>
          </div>
          
          <!-- Dati Amministrativi -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Dati Amministrativi</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="codice_fiscale" id="field_codice_fiscale">
              <label class="form-check-label" for="field_codice_fiscale">Codice Fiscale</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="archived" id="field_archived">
              <label class="form-check-label" for="field_archived">Archiviato</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="created_at" id="field_created_at">
              <label class="form-check-label" for="field_created_at">Data di Creazione</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="form_name" id="field_form_name">
              <label class="form-check-label" for="field_form_name">Nome Form</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="total_score" id="field_total_score">
              <label class="form-check-label" for="field_total_score">Punteggio Totale</label>
            </div>
          </div>
        </div>
        
        <!-- Selezione tipo di esportazione -->
        <div class="row mt-4">
          <div class="col-12">
            <h6>Tipo di Esportazione</h6>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="export_scope" id="export_all" value="all" checked>
              <label class="form-check-label" for="export_all">
                <strong>Tutti i candidati</strong> <small class="text-muted">(include anche candidati archiviati se nella vista archiviati)</small>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="export_scope" id="export_filtered" value="filtered">
              <label class="form-check-label" for="export_filtered">
                <strong>Solo candidati attualmente visualizzati</strong> <small class="text-muted" id="filtered_count">(include filtri attivi)</small>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" onclick="processExport()">Esporta</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
